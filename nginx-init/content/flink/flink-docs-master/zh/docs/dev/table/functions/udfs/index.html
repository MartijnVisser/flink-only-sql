
<!DOCTYPE html>
<html lang="zh" dir=>

<head>
  <meta name="generator" content="Hugo 0.101.0" />
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="自定义函数 # 自定义函数（UDF）是一种扩展开发机制，可以用来在查询语句里调用难以用其他方式表达的频繁使用或自定义的逻辑。
自定义函数可以用 JVM 语言（例如 Java 或 Scala）或 Python 实现，实现者可以在 UDF 中使用任意第三方库，本文聚焦于使用 JVM 语言开发自定义函数。
概述 # 当前 Flink 有如下几种函数：
标量函数 将标量值转换成一个新标量值； 表值函数 将标量值转换成新的行数据； 聚合函数 将多行数据里的标量值转换成一个新标量值； 表值聚合函数 将多行数据里的标量值转换成新的行数据； 异步表值函数 是异步查询外部数据系统的特殊函数。 注意 标量和表值函数已经使用了新的基于数据类型的类型系统，聚合函数仍然使用基于 TypeInformation 的旧类型系统。
以下示例展示了如何创建一个基本的标量函数，以及如何在 Table API 和 SQL 里调用这个函数。
函数用于 SQL 查询前要先经过注册；而在用于 Table API 时，函数可以先注册后调用，也可以 内联 后直接使用。
Java import org.apache.flink.table.api.*; import org.apache.flink.table.functions.ScalarFunction; import static org.apache.flink.table.api.Expressions.*; // 定义函数逻辑 public static class SubstringFunction extends ScalarFunction { public String eval(String s, Integer begin, Integer end) { return s.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="自定义函数" />
<meta property="og:description" content="自定义函数 # 自定义函数（UDF）是一种扩展开发机制，可以用来在查询语句里调用难以用其他方式表达的频繁使用或自定义的逻辑。
自定义函数可以用 JVM 语言（例如 Java 或 Scala）或 Python 实现，实现者可以在 UDF 中使用任意第三方库，本文聚焦于使用 JVM 语言开发自定义函数。
概述 # 当前 Flink 有如下几种函数：
标量函数 将标量值转换成一个新标量值； 表值函数 将标量值转换成新的行数据； 聚合函数 将多行数据里的标量值转换成一个新标量值； 表值聚合函数 将多行数据里的标量值转换成新的行数据； 异步表值函数 是异步查询外部数据系统的特殊函数。 注意 标量和表值函数已经使用了新的基于数据类型的类型系统，聚合函数仍然使用基于 TypeInformation 的旧类型系统。
以下示例展示了如何创建一个基本的标量函数，以及如何在 Table API 和 SQL 里调用这个函数。
函数用于 SQL 查询前要先经过注册；而在用于 Table API 时，函数可以先注册后调用，也可以 内联 后直接使用。
Java import org.apache.flink.table.api.*; import org.apache.flink.table.functions.ScalarFunction; import static org.apache.flink.table.api.Expressions.*; // 定义函数逻辑 public static class SubstringFunction extends ScalarFunction { public String eval(String s, Integer begin, Integer end) { return s." />
<meta property="og:type" content="article" />
<meta property="og:url" content="//localhost/flink/flink-docs-master/zh/docs/dev/table/functions/udfs/" /><meta property="article:section" content="docs" />



<title>自定义函数 | Apache Flink</title>
<link rel="manifest" href="/flink/flink-docs-master/manifest.json">
<link rel="icon" href="/flink/flink-docs-master/favicon.png" type="image/x-icon">
<link rel="alternate" hreflang="en" href="//localhost/flink/flink-docs-master/docs/dev/table/functions/udfs/" title="User-defined Functions">

<link rel="stylesheet" href="/flink/flink-docs-master/book.min.cfa969c0236ea3f501a95207a79d9b434d5a42908877ff66deafc7f3a304c9fd.css" integrity="sha256-z6lpwCNuo/UBqVIHp52bQ01aQpCId/9m3q/H86MEyf0=">
<script defer src="/flink/flink-docs-master/zh.search.min.f2cc452e5e32805e4f8443bc00dcab0c1bba9848c175310b34cc9923a6265e79.js" integrity="sha256-8sxFLl4ygF5PhEO8ANyrDBu6mEjBdTELNMyZI6YmXnk="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  

<link rel="stylesheet" type="text/css" href="//localhost/flink/flink-docs-master/font-awesome/css/font-awesome.min.css">
<script src="//localhost/flink/flink-docs-master/js/anchor.min.js"></script>
<script src="//localhost/flink/flink-docs-master/js/flink.js"></script>


    <script>
         
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";var t=[],r=Object.getPrototypeOf,s=t.slice,g=t.flat?function(e){return t.flat.call(e)}:function(e){return t.concat.apply([],e)},u=t.push,i=t.indexOf,n={},o=n.toString,y=n.hasOwnProperty,a=y.toString,l=a.call(Object),v={},m=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},x=function(e){return null!=e&&e===e.window},E=C.document,c={type:!0,src:!0,nonce:!0,noModule:!0};function b(e,t,n){var r,i,o=(n=n||E).createElement("script");if(o.text=e,t)for(r in c)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function w(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[o.call(e)]||"object":typeof e}var f="3.6.1",S=function(e,t){return new S.fn.init(e,t)};function p(e){var t=!!e&&"length"in e&&e.length,n=w(e);return!m(e)&&!x(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}S.fn=S.prototype={jquery:f,constructor:S,length:0,toArray:function(){return s.call(this)},get:function(e){return null==e?s.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=S.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return S.each(this,e)},map:function(n){return this.pushStack(S.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(S.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(S.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},S.extend=S.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||m(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(S.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||S.isPlainObject(n)?n:{},i=!1,a[t]=S.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},S.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==o.call(e))&&(!(t=r(e))||"function"==typeof(n=y.call(t,"constructor")&&t.constructor)&&a.call(n)===l)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){b(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(p(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},makeArray:function(e,t){var n=t||[];return null!=e&&(p(Object(e))?S.merge(n,"string"==typeof e?[e]:e):u.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:i.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(p(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g(a)},guid:1,support:v}),"function"==typeof Symbol&&(S.fn[Symbol.iterator]=t[Symbol.iterator]),S.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var d=function(n){var e,d,b,o,i,h,f,g,w,u,l,T,C,a,E,y,s,c,v,S="sizzle"+1*new Date,p=n.document,k=0,r=0,m=ue(),x=ue(),A=ue(),N=ue(),j=function(e,t){return e===t&&(l=!0),0},D={}.hasOwnProperty,t=[],q=t.pop,L=t.push,H=t.push,O=t.slice,P=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},R="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",M="[\\x20\\t\\r\\n\\f]",I="(?:\\\\[\\da-fA-F]{1,6}"+M+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",W="\\["+M+"*("+I+")(?:"+M+"*([*^$|!~]?=)"+M+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+I+"))|)"+M+"*\\]",F=":("+I+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+W+")*)|.*)\\)|)",$=new RegExp(M+"+","g"),B=new RegExp("^"+M+"+|((?:^|[^\\\\])(?:\\\\.)*)"+M+"+$","g"),_=new RegExp("^"+M+"*,"+M+"*"),z=new RegExp("^"+M+"*([>+~]|"+M+")"+M+"*"),U=new RegExp(M+"|>"),X=new RegExp(F),V=new RegExp("^"+I+"$"),G={ID:new RegExp("^#("+I+")"),CLASS:new RegExp("^\\.("+I+")"),TAG:new RegExp("^("+I+"|[*])"),ATTR:new RegExp("^"+W),PSEUDO:new RegExp("^"+F),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+M+"*(even|odd|(([+-]|)(\\d*)n|)"+M+"*(?:([+-]|)"+M+"*(\\d+)|))"+M+"*\\)|)","i"),bool:new RegExp("^(?:"+R+")$","i"),needsContext:new RegExp("^"+M+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+M+"*((?:-\\d)?\\d*)"+M+"*\\)|)(?=[^-]|$)","i")},Y=/HTML$/i,Q=/^(?:input|select|textarea|button)$/i,J=/^h\d$/i,K=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=new RegExp("\\\\[\\da-fA-F]{1,6}"+M+"?|\\\\([^\\r\\n\\f])","g"),ne=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ie=function(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},oe=function(){T()},ae=be(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{H.apply(t=O.call(p.childNodes),p.childNodes),t[p.childNodes.length].nodeType}catch(e){H={apply:t.length?function(e,t){L.apply(e,O.call(t))}:function(e,t){var n=e.length,r=0;while(e[n++]=t[r++]);e.length=n-1}}}function se(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&(T(e),e=e||C,E)){if(11!==p&&(u=Z.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(f&&(a=f.getElementById(i))&&v(e,a)&&a.id===i)return n.push(a),n}else{if(u[2])return H.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&d.getElementsByClassName&&e.getElementsByClassName)return H.apply(n,e.getElementsByClassName(i)),n}if(d.qsa&&!N[t+" "]&&(!y||!y.test(t))&&(1!==p||"object"!==e.nodeName.toLowerCase())){if(c=t,f=e,1===p&&(U.test(t)||z.test(t))){(f=ee.test(t)&&ve(e.parentNode)||e)===e&&d.scope||((s=e.getAttribute("id"))?s=s.replace(re,ie):e.setAttribute("id",s=S)),o=(l=h(t)).length;while(o--)l[o]=(s?"#"+s:":scope")+" "+xe(l[o]);c=l.join(",")}try{return H.apply(n,f.querySelectorAll(c)),n}catch(e){N(t,!0)}finally{s===S&&e.removeAttribute("id")}}}return g(t.replace(B,"$1"),e,n,r)}function ue(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function le(e){return e[S]=!0,e}function ce(e){var t=C.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function fe(e,t){var n=e.split("|"),r=n.length;while(r--)b.attrHandle[n[r]]=t}function pe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function de(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function he(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}function ge(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&ae(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function ye(a){return le(function(o){return o=+o,le(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function ve(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}for(e in d=se.support={},i=se.isXML=function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!Y.test(t||n&&n.nodeName||"HTML")},T=se.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:p;return r!=C&&9===r.nodeType&&r.documentElement&&(a=(C=r).documentElement,E=!i(C),p!=C&&(n=C.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",oe,!1):n.attachEvent&&n.attachEvent("onunload",oe)),d.scope=ce(function(e){return a.appendChild(e).appendChild(C.createElement("div")),"undefined"!=typeof e.querySelectorAll&&!e.querySelectorAll(":scope fieldset div").length}),d.attributes=ce(function(e){return e.className="i",!e.getAttribute("className")}),d.getElementsByTagName=ce(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),d.getElementsByClassName=K.test(C.getElementsByClassName),d.getById=ce(function(e){return a.appendChild(e).id=S,!C.getElementsByName||!C.getElementsByName(S).length}),d.getById?(b.filter.ID=function(e){var t=e.replace(te,ne);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(te,ne);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=d.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):d.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},b.find.CLASS=d.getElementsByClassName&&function(e,t){if("undefined"!=typeof t.getElementsByClassName&&E)return t.getElementsByClassName(e)},s=[],y=[],(d.qsa=K.test(C.querySelectorAll))&&(ce(function(e){var t;a.appendChild(e).innerHTML="<a id='"+S+"'></a><select id='"+S+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&y.push("[*^$]="+M+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||y.push("\\["+M+"*(?:value|"+R+")"),e.querySelectorAll("[id~="+S+"-]").length||y.push("~="),(t=C.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||y.push("\\["+M+"*name"+M+"*="+M+"*(?:''|\"\")"),e.querySelectorAll(":checked").length||y.push(":checked"),e.querySelectorAll("a#"+S+"+*").length||y.push(".#.+[+~]"),e.querySelectorAll("\\\f"),y.push("[\\r\\n\\f]")}),ce(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&y.push("name"+M+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&y.push(":enabled",":disabled"),a.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&y.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),y.push(",.*:")})),(d.matchesSelector=K.test(c=a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector||a.msMatchesSelector))&&ce(function(e){d.disconnectedMatch=c.call(e,"*"),c.call(e,"[s!='']:x"),s.push("!=",F)}),y=y.length&&new RegExp(y.join("|")),s=s.length&&new RegExp(s.join("|")),t=K.test(a.compareDocumentPosition),v=t||K.test(a.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},j=t?function(e,t){if(e===t)return l=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!d.sortDetached&&t.compareDocumentPosition(e)===n?e==C||e.ownerDocument==p&&v(p,e)?-1:t==C||t.ownerDocument==p&&v(p,t)?1:u?P(u,e)-P(u,t):0:4&n?-1:1)}:function(e,t){if(e===t)return l=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e==C?-1:t==C?1:i?-1:o?1:u?P(u,e)-P(u,t):0;if(i===o)return pe(e,t);n=e;while(n=n.parentNode)a.unshift(n);n=t;while(n=n.parentNode)s.unshift(n);while(a[r]===s[r])r++;return r?pe(a[r],s[r]):a[r]==p?-1:s[r]==p?1:0}),C},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if(T(e),d.matchesSelector&&E&&!N[t+" "]&&(!s||!s.test(t))&&(!y||!y.test(t)))try{var n=c.call(e,t);if(n||d.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){N(t,!0)}return 0<se(t,C,null,[e]).length},se.contains=function(e,t){return(e.ownerDocument||e)!=C&&T(e),v(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!=C&&T(e);var n=b.attrHandle[t.toLowerCase()],r=n&&D.call(b.attrHandle,t.toLowerCase())?n(e,t,!E):void 0;return void 0!==r?r:d.attributes||!E?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},se.escape=function(e){return(e+"").replace(re,ie)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,n=[],r=0,i=0;if(l=!d.detectDuplicates,u=!d.sortStable&&e.slice(0),e.sort(j),l){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)e.splice(n[r],1)}return u=null,e},o=se.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else while(t=e[r++])n+=o(t);return n},(b=se.selectors={cacheLength:50,createPseudo:le,match:G,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(te,ne),e[3]=(e[3]||e[4]||e[5]||"").replace(te,ne),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return G.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&X.test(n)&&(t=h(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(te,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=m[e+" "];return t||(t=new RegExp("(^|"+M+")"+e+"("+M+"|$)"))&&m(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=se.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace($," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(h,e,t,g,y){var v="nth"!==h.slice(0,3),m="last"!==h.slice(-4),x="of-type"===e;return 1===g&&0===y?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u,l=v!==m?"nextSibling":"previousSibling",c=e.parentNode,f=x&&e.nodeName.toLowerCase(),p=!n&&!x,d=!1;if(c){if(v){while(l){a=e;while(a=a[l])if(x?a.nodeName.toLowerCase()===f:1===a.nodeType)return!1;u=l="only"===h&&!u&&"nextSibling"}return!0}if(u=[m?c.firstChild:c.lastChild],m&&p){d=(s=(r=(i=(o=(a=c)[S]||(a[S]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===k&&r[1])&&r[2],a=s&&c.childNodes[s];while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if(1===a.nodeType&&++d&&a===e){i[h]=[k,s,d];break}}else if(p&&(d=s=(r=(i=(o=(a=e)[S]||(a[S]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===k&&r[1]),!1===d)while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if((x?a.nodeName.toLowerCase()===f:1===a.nodeType)&&++d&&(p&&((i=(o=a[S]||(a[S]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]=[k,d]),a===e))break;return(d-=y)===g||d%g==0&&0<=d/g}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?le(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=P(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:le(function(e){var r=[],i=[],s=f(e.replace(B,"$1"));return s[S]?le(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:le(function(t){return function(e){return 0<se(t,e).length}}),contains:le(function(t){return t=t.replace(te,ne),function(e){return-1<(e.textContent||o(e)).indexOf(t)}}),lang:le(function(n){return V.test(n||"")||se.error("unsupported lang: "+n),n=n.replace(te,ne).toLowerCase(),function(e){var t;do{if(t=E?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===a},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:ge(!1),disabled:ge(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return J.test(e.nodeName)},input:function(e){return Q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:ye(function(){return[0]}),last:ye(function(e,t){return[t-1]}),eq:ye(function(e,t,n){return[n<0?n+t:n]}),even:ye(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:ye(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:ye(function(e,t,n){for(var r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:ye(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=de(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=he(e);function me(){}function xe(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function be(s,e,t){var u=e.dir,l=e.next,c=l||u,f=t&&"parentNode"===c,p=r++;return e.first?function(e,t,n){while(e=e[u])if(1===e.nodeType||f)return s(e,t,n);return!1}:function(e,t,n){var r,i,o,a=[k,p];if(n){while(e=e[u])if((1===e.nodeType||f)&&s(e,t,n))return!0}else while(e=e[u])if(1===e.nodeType||f)if(i=(o=e[S]||(e[S]={}))[e.uniqueID]||(o[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[u]||e;else{if((r=i[c])&&r[0]===k&&r[1]===p)return a[2]=r[2];if((i[c]=a)[2]=s(e,t,n))return!0}return!1}}function we(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Te(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function Ce(d,h,g,y,v,e){return y&&!y[S]&&(y=Ce(y)),v&&!v[S]&&(v=Ce(v,e)),le(function(e,t,n,r){var i,o,a,s=[],u=[],l=t.length,c=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)se(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),f=!d||!e&&h?c:Te(c,s,d,n,r),p=g?v||(e?d:l||y)?[]:t:f;if(g&&g(f,p,n,r),y){i=Te(p,u),y(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(p[u[o]]=!(f[u[o]]=a))}if(e){if(v||d){if(v){i=[],o=p.length;while(o--)(a=p[o])&&i.push(f[o]=a);v(null,p=[],i,r)}o=p.length;while(o--)(a=p[o])&&-1<(i=v?P(e,a):s[o])&&(e[i]=!(t[i]=a))}}else p=Te(p===t?p.splice(l,p.length):p),v?v(null,t,p,r):H.apply(t,p)})}function Ee(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=be(function(e){return e===i},a,!0),l=be(function(e){return-1<P(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!==w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[be(we(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return Ce(1<s&&we(c),1<s&&xe(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(B,"$1"),t,s<n&&Ee(e.slice(s,n)),n<r&&Ee(e=e.slice(n)),n<r&&xe(e))}c.push(t)}return we(c)}return me.prototype=b.filters=b.pseudos,b.setFilters=new me,h=se.tokenize=function(e,t){var n,r,i,o,a,s,u,l=x[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=_.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=z.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(B," ")}),a=a.slice(n.length)),b.filter)!(r=G[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?se.error(e):x(e,s).slice(0)},f=se.compile=function(e,t){var n,y,v,m,x,r,i=[],o=[],a=A[e+" "];if(!a){t||(t=h(e)),n=t.length;while(n--)(a=Ee(t[n]))[S]?i.push(a):o.push(a);(a=A(e,(y=o,m=0<(v=i).length,x=0<y.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=k+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t==C||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument==C||(T(o),n=!E);while(s=y[a++])if(s(o,t||C,n)){r.push(o);break}i&&(k=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=v[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=q.call(r));f=Te(f)}H.apply(r,f),i&&!e&&0<f.length&&1<u+v.length&&se.uniqueSort(r)}return i&&(k=h,w=p),c},m?le(r):r))).selector=e}return a},g=se.select=function(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&h(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&E&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(te,ne),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=G.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(te,ne),ee.test(o[0].type)&&ve(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&xe(o)))return H.apply(n,r),n;break}}}return(l||f(e,c))(r,t,!E,n,!t||ee.test(e)&&ve(t.parentNode)||t),n},d.sortStable=S.split("").sort(j).join("")===S,d.detectDuplicates=!!l,T(),d.sortDetached=ce(function(e){return 1&e.compareDocumentPosition(C.createElement("fieldset"))}),ce(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||fe("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),d.attributes&&ce(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||fe("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),ce(function(e){return null==e.getAttribute("disabled")})||fe(R,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),se}(C);S.find=d,S.expr=d.selectors,S.expr[":"]=S.expr.pseudos,S.uniqueSort=S.unique=d.uniqueSort,S.text=d.getText,S.isXMLDoc=d.isXML,S.contains=d.contains,S.escapeSelector=d.escape;var h=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&S(e).is(n))break;r.push(e)}return r},T=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},k=S.expr.match.needsContext;function A(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var N=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function j(e,n,r){return m(n)?S.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?S.grep(e,function(e){return e===n!==r}):"string"!=typeof n?S.grep(e,function(e){return-1<i.call(n,e)!==r}):S.filter(n,e,r)}S.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?S.find.matchesSelector(r,e)?[r]:[]:S.find.matches(e,S.grep(t,function(e){return 1===e.nodeType}))},S.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(S(e).filter(function(){for(t=0;t<r;t++)if(S.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)S.find(e,i[t],n);return 1<r?S.uniqueSort(n):n},filter:function(e){return this.pushStack(j(this,e||[],!1))},not:function(e){return this.pushStack(j(this,e||[],!0))},is:function(e){return!!j(this,"string"==typeof e&&k.test(e)?S(e):e||[],!1).length}});var D,q=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(S.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||D,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:q.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof S?t[0]:t,S.merge(this,S.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:E,!0)),N.test(r[1])&&S.isPlainObject(t))for(r in t)m(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=E.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):m(e)?void 0!==n.ready?n.ready(e):e(S):S.makeArray(e,this)}).prototype=S.fn,D=S(E);var L=/^(?:parents|prev(?:Until|All))/,H={children:!0,contents:!0,next:!0,prev:!0};function O(e,t){while((e=e[t])&&1!==e.nodeType);return e}S.fn.extend({has:function(e){var t=S(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(S.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&S(e);if(!k.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&S.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?S.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?i.call(S(e),this[0]):i.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(S.uniqueSort(S.merge(this.get(),S(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),S.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return h(e,"parentNode")},parentsUntil:function(e,t,n){return h(e,"parentNode",n)},next:function(e){return O(e,"nextSibling")},prev:function(e){return O(e,"previousSibling")},nextAll:function(e){return h(e,"nextSibling")},prevAll:function(e){return h(e,"previousSibling")},nextUntil:function(e,t,n){return h(e,"nextSibling",n)},prevUntil:function(e,t,n){return h(e,"previousSibling",n)},siblings:function(e){return T((e.parentNode||{}).firstChild,e)},children:function(e){return T(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(A(e,"template")&&(e=e.content||e),S.merge([],e.childNodes))}},function(r,i){S.fn[r]=function(e,t){var n=S.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=S.filter(t,n)),1<this.length&&(H[r]||S.uniqueSort(n),L.test(r)&&n.reverse()),this.pushStack(n)}});var P=/[^\x20\t\r\n\f]+/g;function R(e){return e}function M(e){throw e}function I(e,t,n,r){var i;try{e&&m(i=e.promise)?i.call(e).done(t).fail(n):e&&m(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}S.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},S.each(e.match(P)||[],function(e,t){n[t]=!0}),n):S.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){S.each(e,function(e,t){m(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==w(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return S.each(arguments,function(e,t){var n;while(-1<(n=S.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<S.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},S.extend({Deferred:function(e){var o=[["notify","progress",S.Callbacks("memory"),S.Callbacks("memory"),2],["resolve","done",S.Callbacks("once memory"),S.Callbacks("once memory"),0,"resolved"],["reject","fail",S.Callbacks("once memory"),S.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return S.Deferred(function(r){S.each(o,function(e,t){var n=m(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&m(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,m(t)?s?t.call(e,l(u,o,R,s),l(u,o,M,s)):(u++,t.call(e,l(u,o,R,s),l(u,o,M,s),l(u,o,R,o.notifyWith))):(a!==R&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){S.Deferred.exceptionHook&&S.Deferred.exceptionHook(e,t.stackTrace),u<=i+1&&(a!==M&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(S.Deferred.getStackHook&&(t.stackTrace=S.Deferred.getStackHook()),C.setTimeout(t))}}return S.Deferred(function(e){o[0][3].add(l(0,e,m(r)?r:R,e.notifyWith)),o[1][3].add(l(0,e,m(t)?t:R)),o[2][3].add(l(0,e,m(n)?n:M))}).promise()},promise:function(e){return null!=e?S.extend(e,a):a}},s={};return S.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=s.call(arguments),o=S.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?s.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(I(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||m(i[t]&&i[t].then)))return o.then();while(t--)I(i[t],a(t),o.reject);return o.promise()}});var W=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;S.Deferred.exceptionHook=function(e,t){C.console&&C.console.warn&&e&&W.test(e.name)&&C.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},S.readyException=function(e){C.setTimeout(function(){throw e})};var F=S.Deferred();function $(){E.removeEventListener("DOMContentLoaded",$),C.removeEventListener("load",$),S.ready()}S.fn.ready=function(e){return F.then(e)["catch"](function(e){S.readyException(e)}),this},S.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--S.readyWait:S.isReady)||(S.isReady=!0)!==e&&0<--S.readyWait||F.resolveWith(E,[S])}}),S.ready.then=F.then,"complete"===E.readyState||"loading"!==E.readyState&&!E.documentElement.doScroll?C.setTimeout(S.ready):(E.addEventListener("DOMContentLoaded",$),C.addEventListener("load",$));var B=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===w(n))for(s in i=!0,n)B(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,m(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(S(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},_=/^-ms-/,z=/-([a-z])/g;function U(e,t){return t.toUpperCase()}function X(e){return e.replace(_,"ms-").replace(z,U)}var V=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function G(){this.expando=S.expando+G.uid++}G.uid=1,G.prototype={cache:function(e){var t=e[this.expando];return t||(t={},V(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[X(t)]=n;else for(r in t)i[X(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][X(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(X):(t=X(t))in r?[t]:t.match(P)||[]).length;while(n--)delete r[t[n]]}(void 0===t||S.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!S.isEmptyObject(t)}};var Y=new G,Q=new G,J=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,K=/[A-Z]/g;function Z(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(K,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:J.test(i)?JSON.parse(i):i)}catch(e){}Q.set(e,t,n)}else n=void 0;return n}S.extend({hasData:function(e){return Q.hasData(e)||Y.hasData(e)},data:function(e,t,n){return Q.access(e,t,n)},removeData:function(e,t){Q.remove(e,t)},_data:function(e,t,n){return Y.access(e,t,n)},_removeData:function(e,t){Y.remove(e,t)}}),S.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=Q.get(o),1===o.nodeType&&!Y.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=X(r.slice(5)),Z(o,r,i[r]));Y.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){Q.set(this,n)}):B(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=Q.get(o,n))?t:void 0!==(t=Z(o,n))?t:void 0;this.each(function(){Q.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){Q.remove(this,e)})}}),S.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Y.get(e,t),n&&(!r||Array.isArray(n)?r=Y.access(e,t,S.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=S.queue(e,t),r=n.length,i=n.shift(),o=S._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){S.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Y.get(e,n)||Y.access(e,n,{empty:S.Callbacks("once memory").add(function(){Y.remove(e,[t+"queue",n])})})}}),S.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?S.queue(this[0],t):void 0===n?this:this.each(function(){var e=S.queue(this,t,n);S._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&S.dequeue(this,t)})},dequeue:function(e){return this.each(function(){S.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=S.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=Y.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var ee=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,te=new RegExp("^(?:([+-])=|)("+ee+")([a-z%]*)$","i"),ne=["Top","Right","Bottom","Left"],re=E.documentElement,ie=function(e){return S.contains(e.ownerDocument,e)},oe={composed:!0};re.getRootNode&&(ie=function(e){return S.contains(e.ownerDocument,e)||e.getRootNode(oe)===e.ownerDocument});var ae=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&ie(e)&&"none"===S.css(e,"display")};function se(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return S.css(e,t,"")},u=s(),l=n&&n[3]||(S.cssNumber[t]?"":"px"),c=e.nodeType&&(S.cssNumber[t]||"px"!==l&&+u)&&te.exec(S.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)S.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,S.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ue={};function le(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=Y.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ae(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ue[s])||(o=a.body.appendChild(a.createElement(s)),u=S.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ue[s]=u)))):"none"!==n&&(l[c]="none",Y.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}S.fn.extend({show:function(){return le(this,!0)},hide:function(){return le(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ae(this)?S(this).show():S(this).hide()})}});var ce,fe,pe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,he=/^$|^module$|\/(?:java|ecma)script/i;ce=E.createDocumentFragment().appendChild(E.createElement("div")),(fe=E.createElement("input")).setAttribute("type","radio"),fe.setAttribute("checked","checked"),fe.setAttribute("name","t"),ce.appendChild(fe),v.checkClone=ce.cloneNode(!0).cloneNode(!0).lastChild.checked,ce.innerHTML="<textarea>x</textarea>",v.noCloneChecked=!!ce.cloneNode(!0).lastChild.defaultValue,ce.innerHTML="<option></option>",v.option=!!ce.lastChild;var ge={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ye(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&A(e,t)?S.merge([e],n):n}function ve(e,t){for(var n=0,r=e.length;n<r;n++)Y.set(e[n],"globalEval",!t||Y.get(t[n],"globalEval"))}ge.tbody=ge.tfoot=ge.colgroup=ge.caption=ge.thead,ge.th=ge.td,v.option||(ge.optgroup=ge.option=[1,"<select multiple='multiple'>","</select>"]);var me=/<|&#?\w+;/;function xe(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===w(o))S.merge(p,o.nodeType?[o]:o);else if(me.test(o)){a=a||f.appendChild(t.createElement("div")),s=(de.exec(o)||["",""])[1].toLowerCase(),u=ge[s]||ge._default,a.innerHTML=u[1]+S.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;S.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<S.inArray(o,r))i&&i.push(o);else if(l=ie(o),a=ye(f.appendChild(o),"script"),l&&ve(a),n){c=0;while(o=a[c++])he.test(o.type||"")&&n.push(o)}return f}var be=/^([^.]*)(?:\.(.+)|)/;function we(){return!0}function Te(){return!1}function Ce(e,t){return e===function(){try{return E.activeElement}catch(e){}}()==("focus"===t)}function Ee(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Ee(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=Te;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return S().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=S.guid++)),e.each(function(){S.event.add(this,t,i,r,n)})}function Se(e,i,o){o?(Y.set(e,i,!1),S.event.add(e,i,{namespace:!1,handler:function(e){var t,n,r=Y.get(this,i);if(1&e.isTrigger&&this[i]){if(r.length)(S.event.special[i]||{}).delegateType&&e.stopPropagation();else if(r=s.call(arguments),Y.set(this,i,r),t=o(this,i),this[i](),r!==(n=Y.get(this,i))||t?Y.set(this,i,!1):n={},r!==n)return e.stopImmediatePropagation(),e.preventDefault(),n&&n.value}else r.length&&(Y.set(this,i,{value:S.event.trigger(S.extend(r[0],S.Event.prototype),r.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===Y.get(e,i)&&S.event.add(e,i,we)}S.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,y=Y.get(t);if(V(t)){n.handler&&(n=(o=n).handler,i=o.selector),i&&S.find.matchesSelector(re,i),n.guid||(n.guid=S.guid++),(u=y.events)||(u=y.events=Object.create(null)),(a=y.handle)||(a=y.handle=function(e){return"undefined"!=typeof S&&S.event.triggered!==e.type?S.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(P)||[""]).length;while(l--)d=g=(s=be.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=S.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=S.event.special[d]||{},c=S.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&S.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),S.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,y=Y.hasData(e)&&Y.get(e);if(y&&(u=y.events)){l=(t=(t||"").match(P)||[""]).length;while(l--)if(d=g=(s=be.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=S.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,y.handle)||S.removeEvent(e,d,y.handle),delete u[d])}else for(d in u)S.event.remove(e,d+t[l],n,r,!0);S.isEmptyObject(u)&&Y.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=new Array(arguments.length),u=S.event.fix(e),l=(Y.get(this,"events")||Object.create(null))[u.type]||[],c=S.event.special[u.type]||{};for(s[0]=u,t=1;t<arguments.length;t++)s[t]=arguments[t];if(u.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,u)){a=S.event.handlers.call(this,u,l),t=0;while((i=a[t++])&&!u.isPropagationStopped()){u.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!u.isImmediatePropagationStopped())u.rnamespace&&!1!==o.namespace&&!u.rnamespace.test(o.namespace)||(u.handleObj=o,u.data=o.data,void 0!==(r=((S.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))&&!1===(u.result=r)&&(u.preventDefault(),u.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,u),u.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<S(i,this).index(l):S.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(S.Event.prototype,t,{enumerable:!0,configurable:!0,get:m(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[S.expando]?e:new S.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&Se(t,"click",we),!1},trigger:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&Se(t,"click"),!0},_default:function(e){var t=e.target;return pe.test(t.type)&&t.click&&A(t,"input")&&Y.get(t,"click")||A(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},S.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},S.Event=function(e,t){if(!(this instanceof S.Event))return new S.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?we:Te,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&S.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[S.expando]=!0},S.Event.prototype={constructor:S.Event,isDefaultPrevented:Te,isPropagationStopped:Te,isImmediatePropagationStopped:Te,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=we,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=we,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=we,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},S.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},S.event.addProp),S.each({focus:"focusin",blur:"focusout"},function(t,e){S.event.special[t]={setup:function(){return Se(this,t,Ce),!1},trigger:function(){return Se(this,t),!0},_default:function(e){return Y.get(e.target,t)},delegateType:e}}),S.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){S.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||S.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),S.fn.extend({on:function(e,t,n,r){return Ee(this,e,t,n,r)},one:function(e,t,n,r){return Ee(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,S(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=Te),this.each(function(){S.event.remove(this,e,n,t)})}});var ke=/<script|<style|<link/i,Ae=/checked\s*(?:[^=]|=\s*.checked.)/i,Ne=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function je(e,t){return A(e,"table")&&A(11!==t.nodeType?t:t.firstChild,"tr")&&S(e).children("tbody")[0]||e}function De(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function qe(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Le(e,t){var n,r,i,o,a,s;if(1===t.nodeType){if(Y.hasData(e)&&(s=Y.get(e).events))for(i in Y.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)S.event.add(t,i,s[i][n]);Q.hasData(e)&&(o=Q.access(e),a=S.extend({},o),Q.set(t,a))}}function He(n,r,i,o){r=g(r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=m(d);if(h||1<f&&"string"==typeof d&&!v.checkClone&&Ae.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),He(t,r,i,o)});if(f&&(t=(e=xe(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=S.map(ye(e,"script"),De)).length;c<f;c++)u=e,c!==p&&(u=S.clone(u,!0,!0),s&&S.merge(a,ye(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,S.map(a,qe),c=0;c<s;c++)u=a[c],he.test(u.type||"")&&!Y.access(u,"globalEval")&&S.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?S._evalUrl&&!u.noModule&&S._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):b(u.textContent.replace(Ne,""),u,l))}return n}function Oe(e,t,n){for(var r,i=t?S.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||S.cleanData(ye(r)),r.parentNode&&(n&&ie(r)&&ve(ye(r,"script")),r.parentNode.removeChild(r));return e}S.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=ie(e);if(!(v.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||S.isXMLDoc(e)))for(a=ye(c),r=0,i=(o=ye(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&pe.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||ye(e),a=a||ye(c),r=0,i=o.length;r<i;r++)Le(o[r],a[r]);else Le(e,c);return 0<(a=ye(c,"script")).length&&ve(a,!f&&ye(e,"script")),c},cleanData:function(e){for(var t,n,r,i=S.event.special,o=0;void 0!==(n=e[o]);o++)if(V(n)){if(t=n[Y.expando]){if(t.events)for(r in t.events)i[r]?S.event.remove(n,r):S.removeEvent(n,r,t.handle);n[Y.expando]=void 0}n[Q.expando]&&(n[Q.expando]=void 0)}}}),S.fn.extend({detach:function(e){return Oe(this,e,!0)},remove:function(e){return Oe(this,e)},text:function(e){return B(this,function(e){return void 0===e?S.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return He(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||je(this,e).appendChild(e)})},prepend:function(){return He(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=je(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return He(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return He(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(S.cleanData(ye(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return S.clone(this,e,t)})},html:function(e){return B(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!ke.test(e)&&!ge[(de.exec(e)||["",""])[1].toLowerCase()]){e=S.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(S.cleanData(ye(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return He(this,arguments,function(e){var t=this.parentNode;S.inArray(this,n)<0&&(S.cleanData(ye(this)),t&&t.replaceChild(e,this))},n)}}),S.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){S.fn[e]=function(e){for(var t,n=[],r=S(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),S(r[o])[a](t),u.apply(n,t.get());return this.pushStack(n)}});var Pe=new RegExp("^("+ee+")(?!px)[a-z%]+$","i"),Re=/^--/,Me=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=C),t.getComputedStyle(e)},Ie=function(e,t,n){var r,i,o={};for(i in t)o[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=o[i];return r},We=new RegExp(ne.join("|"),"i"),Fe="[\\x20\\t\\r\\n\\f]",$e=new RegExp("^"+Fe+"+|((?:^|[^\\\\])(?:\\\\.)*)"+Fe+"+$","g");function Be(e,t,n){var r,i,o,a,s=Re.test(t),u=e.style;return(n=n||Me(e))&&(a=n.getPropertyValue(t)||n[t],s&&(a=a.replace($e,"$1")),""!==a||ie(e)||(a=S.style(e,t)),!v.pixelBoxStyles()&&Pe.test(a)&&We.test(t)&&(r=u.width,i=u.minWidth,o=u.maxWidth,u.minWidth=u.maxWidth=u.width=a,a=n.width,u.width=r,u.minWidth=i,u.maxWidth=o)),void 0!==a?a+"":a}function _e(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",re.appendChild(u).appendChild(l);var e=C.getComputedStyle(l);n="1%"!==e.top,s=12===t(e.marginLeft),l.style.right="60%",o=36===t(e.right),r=36===t(e.width),l.style.position="absolute",i=12===t(l.offsetWidth/3),re.removeChild(u),l=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s,u=E.createElement("div"),l=E.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",v.clearCloneStyle="content-box"===l.style.backgroundClip,S.extend(v,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),s},scrollboxSize:function(){return e(),i},reliableTrDimensions:function(){var e,t,n,r;return null==a&&(e=E.createElement("table"),t=E.createElement("tr"),n=E.createElement("div"),e.style.cssText="position:absolute;left:-11111px;border-collapse:separate",t.style.cssText="border:1px solid",t.style.height="1px",n.style.height="9px",n.style.display="block",re.appendChild(e).appendChild(t).appendChild(n),r=C.getComputedStyle(t),a=parseInt(r.height,10)+parseInt(r.borderTopWidth,10)+parseInt(r.borderBottomWidth,10)===t.offsetHeight,re.removeChild(e)),a}}))}();var ze=["Webkit","Moz","ms"],Ue=E.createElement("div").style,Xe={};function Ve(e){var t=S.cssProps[e]||Xe[e];return t||(e in Ue?e:Xe[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=ze.length;while(n--)if((e=ze[n]+t)in Ue)return e}(e)||e)}var Ge=/^(none|table(?!-c[ea]).+)/,Ye={position:"absolute",visibility:"hidden",display:"block"},Qe={letterSpacing:"0",fontWeight:"400"};function Je(e,t,n){var r=te.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function Ke(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(u+=S.css(e,n+ne[a],!0,i)),r?("content"===n&&(u-=S.css(e,"padding"+ne[a],!0,i)),"margin"!==n&&(u-=S.css(e,"border"+ne[a]+"Width",!0,i))):(u+=S.css(e,"padding"+ne[a],!0,i),"padding"!==n?u+=S.css(e,"border"+ne[a]+"Width",!0,i):s+=S.css(e,"border"+ne[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u}function Ze(e,t,n){var r=Me(e),i=(!v.boxSizingReliable()||n)&&"border-box"===S.css(e,"boxSizing",!1,r),o=i,a=Be(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(Pe.test(a)){if(!n)return a;a="auto"}return(!v.boxSizingReliable()&&i||!v.reliableTrDimensions()&&A(e,"tr")||"auto"===a||!parseFloat(a)&&"inline"===S.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===S.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+Ke(e,t,n||(i?"border":"content"),o,r,a)+"px"}function et(e,t,n,r,i){return new et.prototype.init(e,t,n,r,i)}S.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Be(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=X(t),u=Re.test(t),l=e.style;if(u||(t=Ve(s)),a=S.cssHooks[t]||S.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=te.exec(n))&&i[1]&&(n=se(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(S.cssNumber[s]?"":"px")),v.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=X(t);return Re.test(t)||(t=Ve(s)),(a=S.cssHooks[t]||S.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=Be(e,t,r)),"normal"===i&&t in Qe&&(i=Qe[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),S.each(["height","width"],function(e,u){S.cssHooks[u]={get:function(e,t,n){if(t)return!Ge.test(S.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?Ze(e,u,n):Ie(e,Ye,function(){return Ze(e,u,n)})},set:function(e,t,n){var r,i=Me(e),o=!v.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===S.css(e,"boxSizing",!1,i),s=n?Ke(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-Ke(e,u,"border",!1,i)-.5)),s&&(r=te.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=S.css(e,u)),Je(0,t,s)}}}),S.cssHooks.marginLeft=_e(v.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Be(e,"marginLeft"))||e.getBoundingClientRect().left-Ie(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),S.each({margin:"",padding:"",border:"Width"},function(i,o){S.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+ne[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(S.cssHooks[i+o].set=Je)}),S.fn.extend({css:function(e,t){return B(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Me(e),i=t.length;a<i;a++)o[t[a]]=S.css(e,t[a],!1,r);return o}return void 0!==n?S.style(e,t,n):S.css(e,t)},e,t,1<arguments.length)}}),((S.Tween=et).prototype={constructor:et,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||S.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(S.cssNumber[n]?"":"px")},cur:function(){var e=et.propHooks[this.prop];return e&&e.get?e.get(this):et.propHooks._default.get(this)},run:function(e){var t,n=et.propHooks[this.prop];return this.options.duration?this.pos=t=S.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):et.propHooks._default.set(this),this}}).init.prototype=et.prototype,(et.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=S.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){S.fx.step[e.prop]?S.fx.step[e.prop](e):1!==e.elem.nodeType||!S.cssHooks[e.prop]&&null==e.elem.style[Ve(e.prop)]?e.elem[e.prop]=e.now:S.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=et.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},S.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},S.fx=et.prototype.init,S.fx.step={};var tt,nt,rt,it,ot=/^(?:toggle|show|hide)$/,at=/queueHooks$/;function st(){nt&&(!1===E.hidden&&C.requestAnimationFrame?C.requestAnimationFrame(st):C.setTimeout(st,S.fx.interval),S.fx.tick())}function ut(){return C.setTimeout(function(){tt=void 0}),tt=Date.now()}function lt(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=ne[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function ct(e,t,n){for(var r,i=(ft.tweeners[t]||[]).concat(ft.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function ft(o,e,t){var n,a,r=0,i=ft.prefilters.length,s=S.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=tt||ut(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:S.extend({},e),opts:S.extend(!0,{specialEasing:{},easing:S.easing._default},t),originalProperties:e,originalOptions:t,startTime:tt||ut(),duration:t.duration,tweens:[],createTween:function(e,t){var n=S.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=X(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=S.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=ft.prefilters[r].call(l,o,c,l.opts))return m(n.stop)&&(S._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return S.map(c,ct,l),m(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),S.fx.timer(S.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}S.Animation=S.extend(ft,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return se(n.elem,e,te.exec(t),n),n}]},tweener:function(e,t){m(e)?(t=e,e=["*"]):e=e.match(P);for(var n,r=0,i=e.length;r<i;r++)n=e[r],ft.tweeners[n]=ft.tweeners[n]||[],ft.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ae(e),y=Y.get(e,"fxshow");for(r in n.queue||(null==(a=S._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,S.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],ot.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!y||void 0===y[r])continue;g=!0}d[r]=y&&y[r]||S.style(e,r)}if((u=!S.isEmptyObject(t))||!S.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=y&&y.display)&&(l=Y.get(e,"display")),"none"===(c=S.css(e,"display"))&&(l?c=l:(le([e],!0),l=e.style.display||l,c=S.css(e,"display"),le([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===S.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(y?"hidden"in y&&(g=y.hidden):y=Y.access(e,"fxshow",{display:l}),o&&(y.hidden=!g),g&&le([e],!0),p.done(function(){for(r in g||le([e]),Y.remove(e,"fxshow"),d)S.style(e,r,d[r])})),u=ct(g?y[r]:0,r,p),r in y||(y[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?ft.prefilters.unshift(e):ft.prefilters.push(e)}}),S.speed=function(e,t,n){var r=e&&"object"==typeof e?S.extend({},e):{complete:n||!n&&t||m(e)&&e,duration:e,easing:n&&t||t&&!m(t)&&t};return S.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in S.fx.speeds?r.duration=S.fx.speeds[r.duration]:r.duration=S.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){m(r.old)&&r.old.call(this),r.queue&&S.dequeue(this,r.queue)},r},S.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ae).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=S.isEmptyObject(t),o=S.speed(e,n,r),a=function(){var e=ft(this,S.extend({},t),o);(i||Y.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=S.timers,r=Y.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&at.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||S.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=Y.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=S.timers,o=n?n.length:0;for(t.finish=!0,S.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),S.each(["toggle","show","hide"],function(e,r){var i=S.fn[r];S.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(lt(r,!0),e,t,n)}}),S.each({slideDown:lt("show"),slideUp:lt("hide"),slideToggle:lt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){S.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),S.timers=[],S.fx.tick=function(){var e,t=0,n=S.timers;for(tt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||S.fx.stop(),tt=void 0},S.fx.timer=function(e){S.timers.push(e),S.fx.start()},S.fx.interval=13,S.fx.start=function(){nt||(nt=!0,st())},S.fx.stop=function(){nt=null},S.fx.speeds={slow:600,fast:200,_default:400},S.fn.delay=function(r,e){return r=S.fx&&S.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=C.setTimeout(e,r);t.stop=function(){C.clearTimeout(n)}})},rt=E.createElement("input"),it=E.createElement("select").appendChild(E.createElement("option")),rt.type="checkbox",v.checkOn=""!==rt.value,v.optSelected=it.selected,(rt=E.createElement("input")).value="t",rt.type="radio",v.radioValue="t"===rt.value;var pt,dt=S.expr.attrHandle;S.fn.extend({attr:function(e,t){return B(this,S.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){S.removeAttr(this,e)})}}),S.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?S.prop(e,t,n):(1===o&&S.isXMLDoc(e)||(i=S.attrHooks[t.toLowerCase()]||(S.expr.match.bool.test(t)?pt:void 0)),void 0!==n?null===n?void S.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=S.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!v.radioValue&&"radio"===t&&A(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(P);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),pt={set:function(e,t,n){return!1===t?S.removeAttr(e,n):e.setAttribute(n,n),n}},S.each(S.expr.match.bool.source.match(/\w+/g),function(e,t){var a=dt[t]||S.find.attr;dt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=dt[o],dt[o]=r,r=null!=a(e,t,n)?o:null,dt[o]=i),r}});var ht=/^(?:input|select|textarea|button)$/i,gt=/^(?:a|area)$/i;function yt(e){return(e.match(P)||[]).join(" ")}function vt(e){return e.getAttribute&&e.getAttribute("class")||""}function mt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(P)||[]}S.fn.extend({prop:function(e,t){return B(this,S.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[S.propFix[e]||e]})}}),S.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&S.isXMLDoc(e)||(t=S.propFix[t]||t,i=S.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=S.find.attr(e,"tabindex");return t?parseInt(t,10):ht.test(e.nodeName)||gt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),v.optSelected||(S.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),S.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){S.propFix[this.toLowerCase()]=this}),S.fn.extend({addClass:function(t){var e,n,r,i,o,a;return m(t)?this.each(function(e){S(this).addClass(t.call(this,e,vt(this)))}):(e=mt(t)).length?this.each(function(){if(r=vt(this),n=1===this.nodeType&&" "+yt(r)+" "){for(o=0;o<e.length;o++)i=e[o],n.indexOf(" "+i+" ")<0&&(n+=i+" ");a=yt(n),r!==a&&this.setAttribute("class",a)}}):this},removeClass:function(t){var e,n,r,i,o,a;return m(t)?this.each(function(e){S(this).removeClass(t.call(this,e,vt(this)))}):arguments.length?(e=mt(t)).length?this.each(function(){if(r=vt(this),n=1===this.nodeType&&" "+yt(r)+" "){for(o=0;o<e.length;o++){i=e[o];while(-1<n.indexOf(" "+i+" "))n=n.replace(" "+i+" "," ")}a=yt(n),r!==a&&this.setAttribute("class",a)}}):this:this.attr("class","")},toggleClass:function(t,n){var e,r,i,o,a=typeof t,s="string"===a||Array.isArray(t);return m(t)?this.each(function(e){S(this).toggleClass(t.call(this,e,vt(this),n),n)}):"boolean"==typeof n&&s?n?this.addClass(t):this.removeClass(t):(e=mt(t),this.each(function(){if(s)for(o=S(this),i=0;i<e.length;i++)r=e[i],o.hasClass(r)?o.removeClass(r):o.addClass(r);else void 0!==t&&"boolean"!==a||((r=vt(this))&&Y.set(this,"__className__",r),this.setAttribute&&this.setAttribute("class",r||!1===t?"":Y.get(this,"__className__")||""))}))},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+yt(vt(n))+" ").indexOf(t))return!0;return!1}});var xt=/\r/g;S.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=m(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,S(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=S.map(t,function(e){return null==e?"":e+""})),(r=S.valHooks[this.type]||S.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=S.valHooks[t.type]||S.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(xt,""):null==e?"":e:void 0}}),S.extend({valHooks:{option:{get:function(e){var t=S.find.attr(e,"value");return null!=t?t:yt(S.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!A(n.parentNode,"optgroup"))){if(t=S(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=S.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<S.inArray(S.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),S.each(["radio","checkbox"],function(){S.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<S.inArray(S(e).val(),t)}},v.checkOn||(S.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),v.focusin="onfocusin"in C;var bt=/^(?:focusinfocus|focusoutblur)$/,wt=function(e){e.stopPropagation()};S.extend(S.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||E],d=y.call(e,"type")?e.type:e,h=y.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||E,3!==n.nodeType&&8!==n.nodeType&&!bt.test(d+S.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[S.expando]?e:new S.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:S.makeArray(t,[e]),c=S.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!x(n)){for(s=c.delegateType||d,bt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||E)&&p.push(a.defaultView||a.parentWindow||C)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(Y.get(o,"events")||Object.create(null))[e.type]&&Y.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&V(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!V(n)||u&&m(n[d])&&!x(n)&&((a=n[u])&&(n[u]=null),S.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,wt),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,wt),S.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=S.extend(new S.Event,n,{type:e,isSimulated:!0});S.event.trigger(r,null,t)}}),S.fn.extend({trigger:function(e,t){return this.each(function(){S.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return S.event.trigger(e,t,n,!0)}}),v.focusin||S.each({focus:"focusin",blur:"focusout"},function(n,r){var i=function(e){S.event.simulate(r,e.target,S.event.fix(e))};S.event.special[r]={setup:function(){var e=this.ownerDocument||this.document||this,t=Y.access(e,r);t||e.addEventListener(n,i,!0),Y.access(e,r,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this.document||this,t=Y.access(e,r)-1;t?Y.access(e,r,t):(e.removeEventListener(n,i,!0),Y.remove(e,r))}}});var Tt=C.location,Ct={guid:Date.now()},Et=/\?/;S.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{t=(new C.DOMParser).parseFromString(e,"text/xml")}catch(e){}return n=t&&t.getElementsByTagName("parsererror")[0],t&&!n||S.error("Invalid XML: "+(n?S.map(n.childNodes,function(e){return e.textContent}).join("\n"):e)),t};var St=/\[\]$/,kt=/\r?\n/g,At=/^(?:submit|button|image|reset|file)$/i,Nt=/^(?:input|select|textarea|keygen)/i;function jt(n,e,r,i){var t;if(Array.isArray(e))S.each(e,function(e,t){r||St.test(n)?i(n,t):jt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==w(e))i(n,e);else for(t in e)jt(n+"["+t+"]",e[t],r,i)}S.param=function(e,t){var n,r=[],i=function(e,t){var n=m(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!S.isPlainObject(e))S.each(e,function(){i(this.name,this.value)});else for(n in e)jt(n,e[n],t,i);return r.join("&")},S.fn.extend({serialize:function(){return S.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=S.prop(this,"elements");return e?S.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!S(this).is(":disabled")&&Nt.test(this.nodeName)&&!At.test(e)&&(this.checked||!pe.test(e))}).map(function(e,t){var n=S(this).val();return null==n?null:Array.isArray(n)?S.map(n,function(e){return{name:t.name,value:e.replace(kt,"\r\n")}}):{name:t.name,value:n.replace(kt,"\r\n")}}).get()}});var Dt=/%20/g,qt=/#.*$/,Lt=/([?&])_=[^&]*/,Ht=/^(.*?):[ \t]*([^\r\n]*)$/gm,Ot=/^(?:GET|HEAD)$/,Pt=/^\/\//,Rt={},Mt={},It="*/".concat("*"),Wt=E.createElement("a");function Ft(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(P)||[];if(m(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function $t(t,i,o,a){var s={},u=t===Mt;function l(e){var r;return s[e]=!0,S.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Bt(e,t){var n,r,i=S.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&S.extend(!0,e,r),e}Wt.href=Tt.href,S.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Tt.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Tt.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":It,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":S.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Bt(Bt(e,S.ajaxSettings),t):Bt(S.ajaxSettings,e)},ajaxPrefilter:Ft(Rt),ajaxTransport:Ft(Mt),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,y=S.ajaxSetup({},t),v=y.context||y,m=y.context&&(v.nodeType||v.jquery)?S(v):S.event,x=S.Deferred(),b=S.Callbacks("once memory"),w=y.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Ht.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(y.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),y.url=((e||y.url||Tt.href)+"").replace(Pt,Tt.protocol+"//"),y.type=t.method||t.type||y.method||y.type,y.dataTypes=(y.dataType||"*").toLowerCase().match(P)||[""],null==y.crossDomain){r=E.createElement("a");try{r.href=y.url,r.href=r.href,y.crossDomain=Wt.protocol+"//"+Wt.host!=r.protocol+"//"+r.host}catch(e){y.crossDomain=!0}}if(y.data&&y.processData&&"string"!=typeof y.data&&(y.data=S.param(y.data,y.traditional)),$t(Rt,y,t,T),h)return T;for(i in(g=S.event&&y.global)&&0==S.active++&&S.event.trigger("ajaxStart"),y.type=y.type.toUpperCase(),y.hasContent=!Ot.test(y.type),f=y.url.replace(qt,""),y.hasContent?y.data&&y.processData&&0===(y.contentType||"").indexOf("application/x-www-form-urlencoded")&&(y.data=y.data.replace(Dt,"+")):(o=y.url.slice(f.length),y.data&&(y.processData||"string"==typeof y.data)&&(f+=(Et.test(f)?"&":"?")+y.data,delete y.data),!1===y.cache&&(f=f.replace(Lt,"$1"),o=(Et.test(f)?"&":"?")+"_="+Ct.guid+++o),y.url=f+o),y.ifModified&&(S.lastModified[f]&&T.setRequestHeader("If-Modified-Since",S.lastModified[f]),S.etag[f]&&T.setRequestHeader("If-None-Match",S.etag[f])),(y.data&&y.hasContent&&!1!==y.contentType||t.contentType)&&T.setRequestHeader("Content-Type",y.contentType),T.setRequestHeader("Accept",y.dataTypes[0]&&y.accepts[y.dataTypes[0]]?y.accepts[y.dataTypes[0]]+("*"!==y.dataTypes[0]?", "+It+"; q=0.01":""):y.accepts["*"]),y.headers)T.setRequestHeader(i,y.headers[i]);if(y.beforeSend&&(!1===y.beforeSend.call(v,T,y)||h))return T.abort();if(u="abort",b.add(y.complete),T.done(y.success),T.fail(y.error),c=$t(Mt,y,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,y]),h)return T;y.async&&0<y.timeout&&(d=C.setTimeout(function(){T.abort("timeout")},y.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&C.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(y,T,n)),!i&&-1<S.inArray("script",y.dataTypes)&&S.inArray("json",y.dataTypes)<0&&(y.converters["text script"]=function(){}),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(y,s,T,i),i?(y.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(S.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(S.etag[f]=u)),204===e||"HEAD"===y.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(v,[o,l,T]):x.rejectWith(v,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,y,i?o:a]),b.fireWith(v,[T,l]),g&&(m.trigger("ajaxComplete",[T,y]),--S.active||S.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return S.get(e,t,n,"json")},getScript:function(e,t){return S.get(e,void 0,t,"script")}}),S.each(["get","post"],function(e,i){S[i]=function(e,t,n,r){return m(t)&&(r=r||n,n=t,t=void 0),S.ajax(S.extend({url:e,type:i,dataType:r,data:t,success:n},S.isPlainObject(e)&&e))}}),S.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),S._evalUrl=function(e,t,n){return S.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){S.globalEval(e,t,n)}})},S.fn.extend({wrapAll:function(e){var t;return this[0]&&(m(e)&&(e=e.call(this[0])),t=S(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return m(n)?this.each(function(e){S(this).wrapInner(n.call(this,e))}):this.each(function(){var e=S(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=m(t);return this.each(function(e){S(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){S(this).replaceWith(this.childNodes)}),this}}),S.expr.pseudos.hidden=function(e){return!S.expr.pseudos.visible(e)},S.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},S.ajaxSettings.xhr=function(){try{return new C.XMLHttpRequest}catch(e){}};var _t={0:200,1223:204},zt=S.ajaxSettings.xhr();v.cors=!!zt&&"withCredentials"in zt,v.ajax=zt=!!zt,S.ajaxTransport(function(i){var o,a;if(v.cors||zt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(_t[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&C.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),S.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),S.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return S.globalEval(e),e}}}),S.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),S.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=S("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),E.head.appendChild(r[0])},abort:function(){i&&i()}}});var Ut,Xt=[],Vt=/(=)\?(?=&|$)|\?\?/;S.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Xt.pop()||S.expando+"_"+Ct.guid++;return this[e]=!0,e}}),S.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Vt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Vt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=m(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Vt,"$1"+r):!1!==e.jsonp&&(e.url+=(Et.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||S.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=C[r],C[r]=function(){o=arguments},n.always(function(){void 0===i?S(C).removeProp(r):C[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Xt.push(r)),o&&m(i)&&i(o[0]),o=i=void 0}),"script"}),v.createHTMLDocument=((Ut=E.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Ut.childNodes.length),S.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(v.createHTMLDocument?((r=(t=E.implementation.createHTMLDocument("")).createElement("base")).href=E.location.href,t.head.appendChild(r)):t=E),o=!n&&[],(i=N.exec(e))?[t.createElement(i[1])]:(i=xe([e],t,o),o&&o.length&&S(o).remove(),S.merge([],i.childNodes)));var r,i,o},S.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=yt(e.slice(s)),e=e.slice(0,s)),m(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&S.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?S("<div>").append(S.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},S.expr.pseudos.animated=function(t){return S.grep(S.timers,function(e){return t===e.elem}).length},S.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=S.css(e,"position"),c=S(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=S.css(e,"top"),u=S.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),m(t)&&(t=t.call(e,n,S.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},S.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){S.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===S.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===S.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=S(e).offset()).top+=S.css(e,"borderTopWidth",!0),i.left+=S.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-S.css(r,"marginTop",!0),left:t.left-i.left-S.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===S.css(e,"position"))e=e.offsetParent;return e||re})}}),S.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;S.fn[t]=function(e){return B(this,function(e,t,n){var r;if(x(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),S.each(["top","left"],function(e,n){S.cssHooks[n]=_e(v.pixelPosition,function(e,t){if(t)return t=Be(e,n),Pe.test(t)?S(e).position()[n]+"px":t})}),S.each({Height:"height",Width:"width"},function(a,s){S.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){S.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return B(this,function(e,t,n){var r;return x(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?S.css(e,t,i):S.style(e,t,n,i)},s,n?e:void 0,n)}})}),S.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){S.fn[t]=function(e){return this.on(t,e)}}),S.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),S.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){S.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}});var Gt=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;S.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),m(e))return r=s.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(s.call(arguments)))}).guid=e.guid=e.guid||S.guid++,i},S.holdReady=function(e){e?S.readyWait++:S.ready(!0)},S.isArray=Array.isArray,S.parseJSON=JSON.parse,S.nodeName=A,S.isFunction=m,S.isWindow=x,S.camelCase=X,S.type=w,S.now=Date.now,S.isNumeric=function(e){var t=S.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},S.trim=function(e){return null==e?"":(e+"").replace(Gt,"$1")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return S});var Yt=C.jQuery,Qt=C.$;return S.noConflict=function(e){return C.$===S&&(C.$=Qt),e&&C.jQuery===S&&(C.jQuery=Yt),S},"undefined"==typeof e&&(C.jQuery=C.$=S),S});
    </script>

    
    <script>
      var _paq = window._paq = window._paq || [];
       
       
      _paq.push(['disableCookies']);
       
      _paq.push(["setDomains", ["*.flink.apache.org","*.nightlies.apache.org/flink"]]);
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//matomo.privacy.apache.org/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();

      

      const xhr = new XMLHttpRequest();
      
      const value_schema = {"value_schema": "{\"type\": \"record\", \"name\": \"User\", \"fields\": [{\"name\": \"url\", \"type\": \"string\"}, {\"name\": \"cookies\", \"type\": \"string\"}, {\"name\": \"datetime\", \"type\": \"string\"}, {\"name\": \"title\", \"type\": \"string\"}, {\"name\": \"browser\", \"type\": \"string\"}, {\"name\": \"screensize\", \"type\": \"string\"}]}"};

      
      
      const payload = {
        value: {
          url: location.href,
          cookies: document.cookie,
          datetime: new Date(),
          title: document.title,
          browser: navigator.userAgent,
          screensize: `${screen.width}x${screen.height}`,
        }
      };

      
      const fullJson = Object.assign({}, value_schema, {records: [payload]});

      
      xhr.open('POST', 'http://localhost:8082/topics/pageview');
      xhr.setRequestHeader('Content-Type', 'application/vnd.kafka.avro.v2+json');
      xhr.send(JSON.stringify(fullJson));

    </script>
    
</head>

<body dir=>
    <script>
      var getIdentifier = (document.cookie.match(/^(?:.*;)?\s*identifier\s*=\s*([^;]+)(?:.*)?$/)||[,null])[1];
      if (!getIdentifier) {
          document.cookie = "identifier=anonymous";
          getIdentifier = 'anonymous';
      }

      if (getIdentifier != 'anonymous') {
          
          var url = 'http://localhost:9200/notifications/_doc/' + getIdentifier;
          var req = new XMLHttpRequest();
          req.responseType = 'json';
          req.open('GET', url, true);
          req.onload  = function() {
              if(req.status == 404 || req.status == 405) {
                  $('#notifications').hide();
              }
              else if (req.status == 200) {
                  var jsonResponse = req.response;
                  notificationResult = jsonResponse._source;
                  if(notificationResult.notification_link == null) {
                      document.getElementById("notificationMessage").innerHTML = notificationResult.notification_text;
                  }
                  else {
                      document.getElementById("notificationMessage").innerHTML = "<a href=\"" + notificationResult.notification_link + "\">" + notificationResult.notification_text + "</a>"
                  }
                  if(notificationResult.notification_text.length > 0) {
                    $('#notifications').show();
                  }
                  else {
                    $('#notifications').hide();
                  }
              }
          };
          req.send(null);
      }
      else {
          $('#notifications').hide();
      }
    </script>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  

<nav>


<a id="logo" href="//localhost/flink/flink-docs-master/zh">
    <img width="70%" src="//localhost/flink/flink-docs-master/flink-header-logo.svg">
</a>
<p style="text-align:right">v1.16-SNAPSHOT</p>

<div class="book-search">
  <input type="text" id="book-search-input" placeholder="搜索" aria-label="搜索" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<div id="notifications" style="border: 5px solid black; display: none;">
    <div class="navbar-logo">
        <div id="notificationMessage">Test</div>
    </div>
</div>










  





  
  <ul>
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-ee00ed8156e685af335ebb5ccd4e75ca" class="toggle"  />
    <label for="section-ee00ed8156e685af335ebb5ccd4e75ca" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-rocket title appetizer" aria-hidden="true"></i>&nbsp;&nbsp;Try Flink</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/try-flink/local_installation/" class="">本地模式安装</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/try-flink/datastream/" class="">基于 DataStream API 实现欺诈检测</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/try-flink/table_api/" class="">基于 Table API 实现实时报表</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/try-flink/flink-operations-playground/" class="">Flink 操作场景</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-a5f62c05e51da2d13fd0cb021dee4187" class="toggle"  />
    <label for="section-a5f62c05e51da2d13fd0cb021dee4187" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-hand-paper-o title appetizer" aria-hidden="true"></i>&nbsp;&nbsp;实践练习</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/learn-flink/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/learn-flink/datastream_api/" class="">DataStream API 简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/learn-flink/etl/" class="">数据管道 & ETL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/learn-flink/streaming_analytics/" class="">流式分析</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/learn-flink/event_driven/" class="">事件驱动应用</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/learn-flink/fault_tolerance/" class="">容错处理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-6c07f7e07850a28420f21d62041fba0d" class="toggle"  />
    <label for="section-6c07f7e07850a28420f21d62041fba0d" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-map-o title appetizer" aria-hidden="true"></i>&nbsp;&nbsp;概念透析</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/concepts/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/concepts/stateful-stream-processing/" class="">有状态流处理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/concepts/time/" class="">及时流处理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/concepts/flink-architecture/" class="">Flink 架构</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/concepts/glossary/" class="">词汇表</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  	<br/>
  
  
    <input type="checkbox" id="section-4be50b0d8f9a243d0d0b85d5143097d6" class="toggle" checked />
    <label for="section-4be50b0d8f9a243d0d0b85d5143097d6" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-code title maindish" aria-hidden="true"></i>&nbsp;&nbsp;应用开发</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-978b3bcc65df430772604fa311c9f9eb" class="toggle"  />
    <label for="section-978b3bcc65df430772604fa311c9f9eb" class="flex justify-between">项目配置<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/configuration/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/configuration/maven/" class="">使用 Maven</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/configuration/gradle/" class="">使用 Gradle</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/configuration/connector/" class="">连接器和格式</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/configuration/testing/" class="">测试的依赖项</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/configuration/advanced/" class="">高级配置</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-cc76d21600ce4269c2fc917d6514fd35" class="toggle"  />
    <label for="section-cc76d21600ce4269c2fc917d6514fd35" class="flex justify-between">DataStream API<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/execution_mode/" class="">执行模式（流/批）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-d1ca6a3ddf6206fe9e3e2905ecc5b840" class="toggle"  />
    <label for="section-d1ca6a3ddf6206fe9e3e2905ecc5b840" class="flex justify-between">事件时间<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/event-time/generating_watermarks/" class="">生成 Watermark</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/event-time/built_in/" class="">内置 Watermark 生成器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/user_defined_functions/" class="">用户自定义 Functions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-d99ef0e0a25e058e76eafba1cd8eaa48" class="toggle"  />
    <label for="section-d99ef0e0a25e058e76eafba1cd8eaa48" class="flex justify-between">状态与容错<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/state/" class="">Working with State</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/broadcast_state/" class="">Broadcast State 模式</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/checkpointing/" class="">Checkpointing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/queryable_state/" class="">Queryable State</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/state_backends/" class="">State Backends</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-f5f5986e7da95b9b579d8ae2bd679031" class="toggle"  />
    <label for="section-f5f5986e7da95b9b579d8ae2bd679031" class="flex justify-between">数据类型以及序列化<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/serialization/types_serialization/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/serialization/schema_evolution/" class="">状态数据结构升级</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/serialization/custom_serialization/" class="">Custom State Serialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/fault-tolerance/serialization/custom_serializers/" class="">自定义序列化器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-ef1281f923b745dff2ed7c163aa9ec7b" class="toggle"  />
    <label for="section-ef1281f923b745dff2ed7c163aa9ec7b" class="flex justify-between">算子<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/operators/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/operators/windows/" class="">窗口</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/operators/joining/" class="">Joining</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/operators/process_function/" class="">Process Function</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/operators/asyncio/" class="">异步 I/O</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/sources/" class="">数据源</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/side_output/" class="">旁路输出</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/application_parameters/" class="">Handling Application Parameters</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/testing/" class="">测试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/experimental/" class="">实验功能</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/scala_api_extensions/" class="">Scala API 扩展</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/java_lambdas/" class="">Java Lambda Expressions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-937b4e61cb5436a4175e69bac4599ad8" class="toggle"  />
    <label for="section-937b4e61cb5436a4175e69bac4599ad8" class="flex justify-between">管理执行<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/execution/execution_configuration/" class="">执行配置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/execution/packaging/" class="">程序打包</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/datastream/execution/parallel/" class="">并行执行</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-8f7718ee0841350d23d794e6e80ecca8" class="toggle" checked />
    <label for="section-8f7718ee0841350d23d794e6e80ecca8" class="flex justify-between">Table API & SQL<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/common/" class="">概念与通用 API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/data_stream_api/" class="">DataStream API Integration</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-437f7dc45a912e6ba89e4658e9cf16c7" class="toggle"  />
    <label for="section-437f7dc45a912e6ba89e4658e9cf16c7" class="flex justify-between">流式概念<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/concepts/overview/" class="">流式概念</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/concepts/dynamic_tables/" class="">动态表 (Dynamic Table)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/concepts/time_attributes/" class="">时间属性</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/concepts/versioned_tables/" class="">时态表（Temporal Tables）</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/concepts/temporal_table_function/" class="">Temporal Table Function</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/tuning/" class="">流式聚合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/types/" class="">数据类型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/timezone/" class="">时区</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/tableapi/" class="">Table API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-4c1e1791793983012460cd817472d096" class="toggle"  />
    <label for="section-4c1e1791793983012460cd817472d096" class="flex justify-between">SQL<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/gettingstarted/" class="">入门</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-5d6c290ca84a704ca1b8b2b8851d96d7" class="toggle"  />
    <label for="section-5d6c290ca84a704ca1b8b2b8851d96d7" class="flex justify-between">Queries 查询<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/hints/" class="">Hints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/with/" class="">WITH 子句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/select/" class="">SELECT 与 WHERE</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/select-distinct/" class="">SELECT DISTINCT</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/window-tvf/" class="">窗口函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/window-agg/" class="">窗口聚合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/group-agg/" class="">分组聚合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/over-agg/" class="">Over聚合</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/joins/" class="">Join</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/window-join/" class="">窗口关联</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/set-ops/" class="">集合操作</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/orderby/" class="">ORDER BY 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/limit/" class="">LIMIT 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/topn/" class="">Top-N</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/window-topn/" class="">窗口 Top-N</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/window-deduplication/" class="">窗口去重</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/deduplication/" class="">去重</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/queries/match_recognize/" class="">模式检测</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/create/" class="">CREATE 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/drop/" class="">DROP 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/alter/" class="">ALTER 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/insert/" class="">INSERT 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/analyze/" class="">ANALYZE 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/describe/" class="">DESCRIBE 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/explain/" class="">EXPLAIN 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/use/" class="">USE 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/show/" class="">SHOW 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/load/" class="">LOAD 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/unload/" class="">UNLOAD 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/set/" class="">SET 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/reset/" class="">RESET 语句</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sql/jar/" class="">JAR Statements</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-b587c52eb9cc90a648b2c07dee157839" class="toggle" checked />
    <label for="section-b587c52eb9cc90a648b2c07dee157839" class="flex justify-between">函数<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/functions/overview/" class="">函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/functions/systemfunctions/" class="">系统（内置）函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/functions/udfs/" class=" active">自定义函数</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/modules/" class="">模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/catalogs/" class="">Catalogs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sqlclient/" class="">SQL 客户端</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/config/" class="">配置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/sourcessinks/" class="">User-defined Sources & Sinks</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-a25fe3d5e31775b296acf374d7cdac92" class="toggle"  />
    <label for="section-a25fe3d5e31775b296acf374d7cdac92" class="flex justify-between">Python API<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/installation/" class="">环境安装</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table_api_tutorial/" class="">Table API 教程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/datastream_tutorial/" class="">DataStream API 教程</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-424bf2ddca17cc2b040ec160630144f2" class="toggle"  />
    <label for="section-424bf2ddca17cc2b040ec160630144f2" class="flex justify-between">Table API<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/intro_to_table_api/" class="">Python Table API 简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/table_environment/" class="">TableEnvironment</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-91932491e3426637ac0c6917c35f993f" class="toggle"  />
    <label for="section-91932491e3426637ac0c6917c35f993f" class="flex justify-between">Operations<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/operations/operations/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/operations/row_based_operations/" class="">Row-based Operations</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/python_types/" class="">数据类型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/system_functions/" class="">系统（内置）函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-2c6dae1d1333e53da24a0d0b4469849e" class="toggle"  />
    <label for="section-2c6dae1d1333e53da24a0d0b4469849e" class="flex justify-between">自定义函数<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/udfs/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/udfs/python_udfs/" class="">普通自定义函数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/udfs/vectorized_python_udfs/" class="">向量化自定义函数</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/conversion_of_pandas/" class="">PyFlink Table 和 Pandas DataFrame 互转</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/conversion_of_data_stream/" class="">Table 和 DataStream 互转</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/sql/" class="">SQL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/catalogs/" class="">Catalogs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/metrics/" class="">指标</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/python_table_api_connectors/" class="">连接器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-42116523be06cf749380b5ce462b0bf6" class="toggle"  />
    <label for="section-42116523be06cf749380b5ce462b0bf6" class="flex justify-between">DataStream API<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/datastream/intro_to_datastream_api/" class="">Python DataStream API 简介</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-412609674eacdd1d31a3f4c67bbb191f" class="toggle"  />
    <label for="section-412609674eacdd1d31a3f4c67bbb191f" class="flex justify-between">Operators<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/datastream/operators/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/datastream/operators/windows/" class="">Windows</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/datastream/operators/process_function/" class="">Process Function</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/datastream/data_types/" class="">Data Types</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/datastream/state/" class="">State</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/dependency_management/" class="">依赖管理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/python_execution_mode/" class="">执行模式</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/python_config/" class="">配置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/debugging/" class="">调试</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/environment_variables/" class="">环境变量</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/faq/" class="">常见问题</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-5a52ce70fd418927b2728cb42455d3d0" class="toggle"  />
    <label for="section-5a52ce70fd418927b2728cb42455d3d0" class="flex justify-between">DataSet API (Legacy)<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/transformations/" class="">Transformations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/zip_elements_guide/" class="">Zipping Elements</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/iterations/" class="">迭代</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/hadoop_compatibility/" class="">Hadoop 兼容</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/local_execution/" class="">本地执行</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/cluster_execution/" class="">集群执行</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/dev/dataset/examples/" class="">Batch 示例</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-f5bf4e18a429153f481150a5e746bb4f" class="toggle"  />
    <label for="section-f5bf4e18a429153f481150a5e746bb4f" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-book title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Libraries</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/cep/" class="">事件处理 (CEP)</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-9e325bde6fa346fed1943947d7ecbef8" class="toggle"  />
    <label for="section-9e325bde6fa346fed1943947d7ecbef8" class="flex justify-between">Graphs<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/gelly/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/gelly/graph_api/" class="">Graph API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/gelly/iterative_graph_processing/" class="">Iterative Graph Processing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/gelly/library_methods/" class="">Library Methods</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/gelly/graph_algorithms/" class="">Graph Algorithms</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/gelly/graph_generators/" class="">Graph Generators</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/gelly/bipartite_graph/" class="">Bipartite Graph</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/libs/state_processor_api/" class="">State Processor API</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-ed82234225dbf97cc7245e5b0cb1addb" class="toggle"  />
    <label for="section-ed82234225dbf97cc7245e5b0cb1addb" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-random title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Connectors</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-a526b98d366d55d2402b163c9f80b4de" class="toggle"  />
    <label for="section-a526b98d366d55d2402b163c9f80b4de" class="flex justify-between">DataStream Connectors<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-c5d27e93a39d1000fee2c771ab8e4c99" class="toggle"  />
    <label for="section-c5d27e93a39d1000fee2c771ab8e4c99" class="flex justify-between">Formats<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/avro/" class="">Avro</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/azure_table_storage/" class="">Azure Table storage</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/csv/" class="">CSV</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/hadoop/" class="">Hadoop</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/json/" class="">JSON</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/parquet/" class="">Parquet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/formats/text_files/" class="">Text files</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/guarantees/" class="">容错保证</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/kafka/" class="">Kafka</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/cassandra/" class="">Cassandra</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/elasticsearch/" class="">Elasticsearch</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/firehose/" class="">Firehose</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/kinesis/" class="">Kinesis</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/filesystem/" class="">文件系统</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/rabbitmq/" class="">RabbitMQ</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/pubsub/" class="">Google Cloud PubSub</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/hybridsource/" class="">Hybrid Source</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/pulsar/" class="">Pulsar</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/datastream/jdbc/" class="">JDBC</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-cd269c4be446b40053a18f8b84110041" class="toggle"  />
    <label for="section-cd269c4be446b40053a18f8b84110041" class="flex justify-between">Table API Connectors<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-4078b95b237c79336e676b4e2edb2772" class="toggle"  />
    <label for="section-4078b95b237c79336e676b4e2edb2772" class="flex justify-between">Formats<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/overview/" class="">Formats</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/csv/" class="">CSV</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/json/" class="">JSON</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/avro/" class="">Avro</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/avro-confluent/" class="">Confluent Avro</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/protobuf/" class="">Protobuf</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/debezium/" class="">Debezium</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/canal/" class="">Canal</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/maxwell/" class="">Maxwell</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/ogg/" class="">Ogg</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/parquet/" class="">Parquet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/orc/" class="">Orc</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/formats/raw/" class="">Raw</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/kafka/" class="">Kafka</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/upsert-kafka/" class="">Upsert Kafka</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/firehose/" class="">Firehose</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/kinesis/" class="">Kinesis</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/jdbc/" class="">JDBC</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/elasticsearch/" class="">Elasticsearch</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/filesystem/" class="">文件系统</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/hbase/" class="">HBase</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/datagen/" class="">DataGen</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/print/" class="">Print</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/blackhole/" class="">BlackHole</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-61ae5a238c9fe2f26340cb03198dfcd7" class="toggle"  />
    <label for="section-61ae5a238c9fe2f26340cb03198dfcd7" class="flex justify-between">Hive<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/hive/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/hive/hive_catalog/" class="">Hive Catalog</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/hive/hive_dialect/" class="">Hive 方言</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/hive/hive_read_write/" class="">Hive Read & Write</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/hive/hive_functions/" class="">Hive Functions</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/table/downloads/" class="">下载页面</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/connectors/dataset/" class="">DataSet Connectors</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-f8c920cc65db331ce219e9ca783fabb2" class="toggle"  />
    <label for="section-f8c920cc65db331ce219e9ca783fabb2" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-sliders title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Deployment</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-f57030cb5bc69ac1d28bd73a2e0fa4a9" class="toggle"  />
    <label for="section-f57030cb5bc69ac1d28bd73a2e0fa4a9" class="flex justify-between">Resource Providers<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-ea9ad33af563289787cbec15cada5824" class="toggle"  />
    <label for="section-ea9ad33af563289787cbec15cada5824" class="flex justify-between">Standalone<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/resource-providers/standalone/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/resource-providers/standalone/working_directory/" class="">Working Directory</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/resource-providers/standalone/docker/" class="">Docker 设置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/resource-providers/standalone/kubernetes/" class="">Kubernetes 设置</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/resource-providers/native_kubernetes/" class="">Native Kubernetes</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/resource-providers/yarn/" class="">YARN</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/config/" class="">配置参数</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-b2b21a6932971423f75546845eaa0270" class="toggle"  />
    <label for="section-b2b21a6932971423f75546845eaa0270" class="flex justify-between">内存配置<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/memory/mem_setup/" class="">配置 Flink 进程的内存</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/memory/mem_setup_tm/" class="">配置 TaskManager 内存</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/memory/mem_setup_jobmanager/" class="">配置 JobManager 内存</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/memory/mem_tuning/" class="">调优指南</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/memory/mem_trouble/" class="">常见问题</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/memory/mem_migration/" class="">升级指南</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/memory/network_mem_tuning/" class="">网络缓冲调优</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/finegrained_resource/" class="">Fine-Grained Resource Management</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/speculative_execution/" class="">Speculative Execution</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/elastic_scaling/" class="">弹性扩缩容</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/cli/" class="">命令行界面</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-3ad52e3c294903bbe597454f3be784d1" class="toggle"  />
    <label for="section-3ad52e3c294903bbe597454f3be784d1" class="flex justify-between">File Systems<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/filesystems/common/" class="">通用配置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/filesystems/overview/" class="">文件系统</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/filesystems/s3/" class="">Amazon S3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/filesystems/gcs/" class="">Google Cloud Storage</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/filesystems/oss/" class="">阿里云 OSS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/filesystems/azure/" class="">Azure Blob 存储</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/filesystems/plugins/" class="">Plugins</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-8e839847034c230e3c48f00e4eea472f" class="toggle"  />
    <label for="section-8e839847034c230e3c48f00e4eea472f" class="flex justify-between">高可用<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/ha/overview/" class="">概览</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/ha/zookeeper_ha/" class="">ZooKeeper 高可用服务</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/ha/kubernetes_ha/" class="">Kubernetes 高可用服务</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/metric_reporters/" class="">Metric Reporters</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-da02acee0967ffc7d941d06ca50959d2" class="toggle"  />
    <label for="section-da02acee0967ffc7d941d06ca50959d2" class="flex justify-between">Security<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/security/security-ssl/" class="">SSL 设置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/security/security-kerberos/" class="">Kerberos</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-fa25a9e1707135a6191375ba5ebf6927" class="toggle"  />
    <label for="section-fa25a9e1707135a6191375ba5ebf6927" class="flex justify-between">REPLs<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/repls/python_shell/" class="">Python REPL</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-b63e989880aebee7e5211ac1d3ce4e9f" class="toggle"  />
    <label for="section-b63e989880aebee7e5211ac1d3ce4e9f" class="flex justify-between">Advanced<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/advanced/external_resources/" class="">扩展资源</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/advanced/historyserver/" class="">History Server</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/deployment/advanced/logging/" class="">日志</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-5b57649c0c94af0841dac91e624830af" class="toggle"  />
    <label for="section-5b57649c0c94af0841dac91e624830af" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-cogs title maindish" aria-hidden="true"></i>&nbsp;&nbsp;Operations</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-42a8c1c4247207b80e64d3d223c23a23" class="toggle"  />
    <label for="section-42a8c1c4247207b80e64d3d223c23a23" class="flex justify-between">状态与容错<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/state/checkpoints/" class="">Checkpoints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/state/checkpointing_under_backpressure/" class="">Checkpointing under backpressure</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/state/savepoints/" class="">Savepoints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/state/checkpoints_vs_savepoints/" class="">Checkpoints 与 Savepoints</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/state/state_backends/" class="">State Backends</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/state/large_state_tuning/" class="">大状态与 Checkpoint 调优</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/state/task_failure_recovery/" class="">Task 故障恢复</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/metrics/" class="">指标</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/rest_api/" class="">REST API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-50f4b9e6604765e74142b0e1cd9fb44d" class="toggle"  />
    <label for="section-50f4b9e6604765e74142b0e1cd9fb44d" class="flex justify-between">Batch<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/batch/batch_shuffle/" class="">Batch Shuffle</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-d4f1bef6f783a5c6d1b2d5f55db8965f" class="toggle"  />
    <label for="section-d4f1bef6f783a5c6d1b2d5f55db8965f" class="flex justify-between">Debugging<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/debugging/debugging_event_time/" class="">调试窗口与事件时间</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/debugging/debugging_classloading/" class="">调试类加载</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/debugging/flame_graphs/" class="">火焰图</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/debugging/application_profiling/" class="">应用程序分析与调试</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-b424141921a30487c09eab3a187e5859" class="toggle"  />
    <label for="section-b424141921a30487c09eab3a187e5859" class="flex justify-between">Monitoring<span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/monitoring/checkpoint_monitoring/" class="">监控 Checkpoint</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/monitoring/back_pressure/" class="">监控反压</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/upgrading/" class="">升级应用程序和 Flink 版本</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/ops/production_ready/" class="">生产就绪情况核对清单</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  	<br/>
  
  
    <input type="checkbox" id="section-ded926075d02fa6eb11100b638eddaf4" class="toggle"  />
    <label for="section-ded926075d02fa6eb11100b638eddaf4" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-cogs title dessert" aria-hidden="true"></i>&nbsp;&nbsp;Flink 开发</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/flinkdev/ide_setup/" class="">导入 Flink 到 IDE 中</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/flinkdev/building/" class="">从源码构建 Flink</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
  
    <input type="checkbox" id="section-98ea7844cf9262a9ba52500fc93377fe" class="toggle"  />
    <label for="section-98ea7844cf9262a9ba52500fc93377fe" class="flex justify-between"><div style="font-weight:450;margin-bottom:0.5em"><i class="fa fa-book title dessert" aria-hidden="true"></i>&nbsp;&nbsp;内幕</div><span>▾</span>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/internals/job_scheduling/" class="">作业调度</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/internals/task_lifecycle/" class="">Task 生命周期</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
  
    <a href="//localhost/flink/flink-docs-master/zh/docs/internals/filesystems/" class="">文件系统</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>
















<br/>
<hr class="menu-break">

<a href="//flink.apache.org" style="color:black;margin-bottom:0.5em"><i class="link fa fa-external-link title" aria-hidden="true"></i> Project Homepage</a>
<br/>

<a href="//localhost/flink/flink-docs-master/api/java/" style="color:black;margin-bottom:0.5em"><i class="link fa fa-external-link title" aria-hidden="true"></i> JavaDocs</a>
<br/>

<a href="//localhost/flink/flink-docs-master/api/scala/index.html#org.apache.flink.api.scala.package" style="color:black;margin-bottom:0.5em"><i class="link fa fa-external-link title" aria-hidden="true"></i> ScalaDocs</a>
<br/>

<a href="//localhost/flink/flink-docs-master/api/python/" style="color:black;margin-bottom:0.5em"><i class="link fa fa-external-link title" aria-hidden="true"></i> PyDocs</a>
<br/>

<hr class="menu-break">
<li style="list-style-type: none">
  <br>
  <input type="checkbox" id="section-version-picker" class="toggle">
  <label for="section-version-picker" class="flex justify-between">
     <div style="font-weight:450;margin-bottom:0.5em">Pick Docs Version</div>
     <span>▾</span>
  </label>
  <ul>
    <a href="//localhost/flink/flink-docs-master/zh">
      1.16-SNAPSHOT (✓)
    </a>
    <hr class="menu-break">
    
      <li>
        <a href="http://localhost/flink/flink-docs-release-1.15">
          v1.15
        </a>
      </li>
    
      <li>
        <a href="http://localhost/flink/flink-docs-release-1.14">
          v1.14
        </a>
      </li>
    
    <hr class="menu-break">
    <li>
      <a href="//localhost/flink/flink-docs-master/zh/versions">
          All Versions
      </a>
    </li>
  </ul>
</li>




  

  


  





<a  href="//localhost/flink/flink-docs-master/docs/dev/table/functions/udfs/" class="flex align-center">
  <i class="fa fa-globe" aria-hidden="true"></i>&nbsp;&nbsp;
  English
</a>


<script src="//localhost/flink/flink-docs-master/js/track-search-terms.js"></script>


</nav>




  <script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/flink/flink-docs-master/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>自定义函数</strong>

  <label for="toc-control">
    
    <img src="/flink/flink-docs-master/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  

<nav id="TableOfContents"><h3>On This Page <button class="toc" onclick="collapseToc()"><i class="fa fa-compress" aria-hidden="true"></i></button></h3>
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#开发指南">开发指南</a>
      <ul>
        <li><a href="#函数类">函数类</a></li>
        <li><a href="#求值方法">求值方法</a></li>
        <li><a href="#类型推导">类型推导</a></li>
        <li><a href="#运行时集成">运行时集成</a></li>
      </ul>
    </li>
    <li><a href="#标量函数">标量函数</a></li>
    <li><a href="#表值函数">表值函数</a></li>
    <li><a href="#聚合函数">聚合函数</a></li>
    <li><a href="#表值聚合函数">表值聚合函数</a></li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      



<article class="markdown">
    <blockquote style="border-color:#f66">
        This documentation is for an unreleased version of Apache Flink. We recommend you use the latest <a href="https://nightlies.apache.org/flink/flink-docs-stable/">stable version</a>.
    </blockquote>
</article>



      
  <article class="markdown"><!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<h1 id="自定义函数">
  自定义函数
  <a class="anchor" href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%87%bd%e6%95%b0">#</a>
</h1>
<p>自定义函数（UDF）是一种扩展开发机制，可以用来在查询语句里调用难以用其他方式表达的频繁使用或自定义的逻辑。</p>
<p>自定义函数可以用 JVM 语言（例如 Java 或 Scala）或 Python 实现，实现者可以在 UDF 中使用任意第三方库，本文聚焦于使用 JVM 语言开发自定义函数。</p>
<h2 id="概述">
  概述
  <a class="anchor" href="#%e6%a6%82%e8%bf%b0">#</a>
</h2>
<p>当前 Flink 有如下几种函数：</p>
<ul>
<li><em>标量函数</em> 将标量值转换成一个新标量值；</li>
<li><em>表值函数</em> 将标量值转换成新的行数据；</li>
<li><em>聚合函数</em> 将多行数据里的标量值转换成一个新标量值；</li>
<li><em>表值聚合函数</em> 将多行数据里的标量值转换成新的行数据；</li>
<li><em>异步表值函数</em> 是异步查询外部数据系统的特殊函数。</li>
</ul>
<p><span class="label label-danger">注意</span> 标量和表值函数已经使用了新的基于<a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/types/">数据类型</a>的类型系统，聚合函数仍然使用基于 <code>TypeInformation</code> 的旧类型系统。</p>
<p>以下示例展示了如何创建一个基本的标量函数，以及如何在 Table API 和 SQL 里调用这个函数。</p>
<p>函数用于 SQL 查询前要先经过注册；而在用于 Table API 时，函数可以先注册后调用，也可以 <em>内联</em> 后直接使用。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-1a14d788-01f7-4582-827f-5dda58de0512"
    id="tabs-1a14d788-01f7-4582-827f-5dda58de0512-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-1a14d788-01f7-4582-827f-5dda58de0512-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">org.apache.flink.table.api.Expressions.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 定义函数逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SubstringFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">eval</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">begin</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">SubstringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">5</span><span class="o">,</span> <span class="n">12</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;SubstringFunction&#34;</span><span class="o">,</span> <span class="n">SubstringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;SubstringFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">5</span><span class="o">,</span> <span class="n">12</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT SubstringFunction(myField, 5, 12) FROM MyTable&#34;</span><span class="o">);</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-1a14d788-01f7-4582-827f-5dda58de0512"
    id="tabs-1a14d788-01f7-4582-827f-5dda58de0512-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-1a14d788-01f7-4582-827f-5dda58de0512-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// define function logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">SubstringFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">begin</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="n">create</span><span class="o">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SubstringFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;SubstringFunction&#34;</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">SubstringFunction</span><span class="o">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;SubstringFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT SubstringFunction(myField, 5, 12) FROM MyTable&#34;</span><span class="o">)</span>
</span></span></code></pre></div></div></div>

<p>对于交互式会话，还可以在使用或注册函数之前对其进行参数化，这样可以把函数 <em>实例</em> 而不是函数 <em>类</em> 用作临时函数。</p>
<p>为确保函数实例可应用于集群环境，参数必须是可序列化的。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-0a4ec6d3-9f17-43bd-9b4d-506ca2cc7ec2"
    id="tabs-0a4ec6d3-9f17-43bd-9b4d-506ca2cc7ec2-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-0a4ec6d3-9f17-43bd-9b4d-506ca2cc7ec2-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">org.apache.flink.table.api.Expressions.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 定义可参数化的函数逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SubstringFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">endInclusive</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">SubstringFunction</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">endInclusive</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">endInclusive</span> <span class="o">=</span> <span class="n">endInclusive</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">eval</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">begin</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">endInclusive</span> <span class="o">?</span> <span class="n">end</span> <span class="o">+</span> <span class="n">1</span> <span class="o">:</span> <span class="n">end</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="k">new</span> <span class="n">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">5</span><span class="o">,</span> <span class="n">12</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;SubstringFunction&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-0a4ec6d3-9f17-43bd-9b4d-506ca2cc7ec2"
    id="tabs-0a4ec6d3-9f17-43bd-9b4d-506ca2cc7ec2-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-0a4ec6d3-9f17-43bd-9b4d-506ca2cc7ec2-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 定义可参数化的函数逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="k">val</span> <span class="n">endInclusive</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">begin</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="n">endInclusive</span> <span class="o">?</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">:</span> <span class="kt">end</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="n">create</span><span class="o">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;SubstringFunction&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
</span></span></code></pre></div></div></div>

<p>你可以在 Table API 中使用 <code>*</code> 表达式作为函数的一个参数，它将被扩展为该表所有的列作为函数对应位置的参数。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-101c5f48-f5a3-4e9a-b8ef-2fdd21a9e007"
    id="tabs-101c5f48-f5a3-4e9a-b8ef-2fdd21a9e007-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-101c5f48-f5a3-4e9a-b8ef-2fdd21a9e007-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">org.apache.flink.table.api.Expressions.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyConcatFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="o">=</span> <span class="n">InputGroup</span><span class="o">.</span><span class="na">ANY</span><span class="o">)</span> <span class="n">Object</span><span class="o">...</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">fields</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">Object</span><span class="o">::</span><span class="n">toString</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用 $(&#34;*&#34;) 作为函数的参数，如果 MyTable 有 3 列 (a, b, c)，
</span></span></span><span class="line"><span class="cl"><span class="c1">// 它们都将会被传给 MyConcatFunction。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">MyConcatFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;*&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 它等价于显式地将所有列传给 MyConcatFunction。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">MyConcatFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;b&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;c&#34;</span><span class="o">)));</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-101c5f48-f5a3-4e9a-b8ef-2fdd21a9e007"
    id="tabs-101c5f48-f5a3-4e9a-b8ef-2fdd21a9e007-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-101c5f48-f5a3-4e9a-b8ef-2fdd21a9e007-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">scala.annotation.varargs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyConcatFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@varargs</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="k">=</span> <span class="nc">InputGroup</span><span class="o">.</span><span class="nc">ANY</span><span class="o">)</span> <span class="n">row</span><span class="k">:</span> <span class="kt">AnyRef*</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">row</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">mkString</span><span class="o">(</span><span class="s">&#34;,&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="n">create</span><span class="o">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用 $&#34;*&#34; 作为函数的参数，如果 MyTable 有 3 个列 (a, b, c)，
</span></span></span><span class="line"><span class="cl"><span class="c1">// 它们都将会被传给 MyConcatFunction。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">MyConcatFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">&#34;*&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 它等价于显式地将所有列传给 MyConcatFunction。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">MyConcatFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">&#34;a&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;b&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;c&#34;</span><span class="o">));</span>
</span></span></code></pre></div></div></div>


<p><a href="#top" class="top pull-right"><i class="fas fa-triangle"></i> Back to top</a></p>


<h2 id="开发指南">
  开发指南
  <a class="anchor" href="#%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97">#</a>
</h2>
<p><span class="label label-danger">注意</span>在聚合函数使用新的类型系统前，本节仅适用于标量和表值函数。</p>
<p>所有的自定义函数都遵循一些基本的实现原则。</p>
<h3 id="函数类">
  函数类
  <a class="anchor" href="#%e5%87%bd%e6%95%b0%e7%b1%bb">#</a>
</h3>
<p>实现类必须继承自合适的基类之一（例如 <code>org.apache.flink.table.functions.ScalarFunction</code> ）。</p>
<p>该类必须声明为 <code>public</code> ，而不是 <code>abstract</code> ，并且可以被全局访问。不允许使用非静态内部类或匿名类。</p>
<p>为了将自定义函数存储在持久化的 catalog 中，该类必须具有默认构造器，且在运行时可实例化。</p>
<p>Anonymous functions in Table API can only be persisted if the function is not stateful (i.e. containing
only transient and static fields).</p>
<h3 id="求值方法">
  求值方法
  <a class="anchor" href="#%e6%b1%82%e5%80%bc%e6%96%b9%e6%b3%95">#</a>
</h3>
<p>基类提供了一组可以被重写的方法，例如 <code>open()</code>、 <code>close()</code> 或 <code>isDeterministic()</code> 。</p>
<p>但是，除了上述方法之外，作用于每条传入记录的主要逻辑还必须通过专门的 <em>求值方法</em> 来实现。</p>
<p>根据函数的种类，后台生成的运算符会在运行时调用诸如 <code>eval()</code>、<code>accumulate()</code> 或 <code>retract()</code> 之类的求值方法。</p>
<p>这些方法必须声明为 <code>public</code> ，并带有一组定义明确的参数。</p>
<p>常规的 JVM 方法调用语义是适用的。因此可以：</p>
<ul>
<li>实现重载的方法，例如 <code>eval(Integer)</code> 和 <code>eval(LocalDateTime)</code>；</li>
<li>使用变长参数，例如 <code>eval(Integer...)</code>;</li>
<li>使用对象继承，例如 <code>eval(Object)</code> 可接受 <code>LocalDateTime</code> 和 <code>Integer</code> 作为参数；</li>
<li>也可组合使用，例如 <code>eval(Object...)</code> 可接受所有类型的参数。</li>
</ul>
<p>以下代码片段展示了一个重载函数的示例：</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-cef0f4dd-cd54-4bd8-a739-a5384709ed14"
    id="tabs-cef0f4dd-cd54-4bd8-a739-a5384709ed14-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-cef0f4dd-cd54-4bd8-a739-a5384709ed14-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 有多个重载求值方法的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SumFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Integer</span> <span class="n">a</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="n">String</span> <span class="n">a</span><span class="o">,</span> <span class="n">String</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Double</span><span class="o">...</span> <span class="n">d</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="kt">double</span> <span class="n">value</span> <span class="o">:</span> <span class="n">d</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-cef0f4dd-cd54-4bd8-a739-a5384709ed14"
    id="tabs-cef0f4dd-cd54-4bd8-a739-a5384709ed14-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-cef0f4dd-cd54-4bd8-a739-a5384709ed14-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">scala.annotation.varargs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 有多个重载求值方法的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">SumFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Integer</span><span class="o">.</span><span class="n">valueOf</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="n">valueOf</span><span class="o">(</span><span class="n">b</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@varargs</span> <span class="c1">// generate var-args like Java
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">Double*</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">toInt</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div></div>

<h3 id="类型推导">
  类型推导
  <a class="anchor" href="#%e7%b1%bb%e5%9e%8b%e6%8e%a8%e5%af%bc">#</a>
</h3>
<p>Table（类似于 SQL 标准）是一种强类型的 API。因此，函数的参数和返回类型都必须映射到<a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/types/">数据类型</a>。</p>
<p>从逻辑角度看，Planner 需要知道数据类型、精度和小数位数；从 JVM 角度来看，Planner 在调用自定义函数时需要知道如何将内部数据结构表示为 JVM 对象。</p>
<p>术语 <em>类型推导</em> 概括了意在验证输入值、派生出参数/返回值数据类型的逻辑。</p>
<p>Flink 自定义函数实现了自动的类型推导提取，通过反射从函数的类及其求值方法中派生数据类型。如果这种隐式的反射提取方法不成功，则可以通过使用 <code>@DataTypeHint</code> 和 <code>@FunctionHint</code> 注解相关参数、类或方法来支持提取过程，下面展示了有关如何注解函数的例子。</p>
<p>如果需要更高级的类型推导逻辑，实现者可以在每个自定义函数中显式重写 <code>getTypeInference()</code> 方法。但是，建议使用注解方式，因为它可使自定义类型推导逻辑保持在受影响位置附近，而在其他位置则保持默认状态。</p>
<h4 id="自动类型推导">
  自动类型推导
  <a class="anchor" href="#%e8%87%aa%e5%8a%a8%e7%b1%bb%e5%9e%8b%e6%8e%a8%e5%af%bc">#</a>
</h4>
<p>自动类型推导会检查函数的类和求值方法，派生出函数参数和结果的数据类型， <code>@DataTypeHint</code> 和 <code>@FunctionHint</code> 注解支持自动类型推导。</p>
<p>有关可以隐式映射到数据类型的类的完整列表，请参阅<a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/types/#%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b%e6%b3%a8%e8%a7%a3">数据类型</a>。</p>
<p><strong><code>@DataTypeHint</code></strong></p>
<p>在许多情况下，需要支持以 <em>内联</em> 方式自动提取出函数参数、返回值的类型。</p>
<p>以下例子展示了如何使用 <code>@DataTypeHint</code>，详情可参考该注解类的文档。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-f5e228c1-ded2-4892-a46d-fdb2431e6841"
    id="tabs-f5e228c1-ded2-4892-a46d-fdb2431e6841-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-f5e228c1-ded2-4892-a46d-fdb2431e6841-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 有多个重载求值方法的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// no hint required
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="n">Long</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">long</span> <span class="n">a</span><span class="o">,</span> <span class="kt">long</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 定义 decimal 的精度和小数位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;DECIMAL(12, 3)&#34;</span><span class="o">)</span> <span class="n">BigDecimal</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">double</span> <span class="n">a</span><span class="o">,</span> <span class="kt">double</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 定义嵌套数据类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;ROW&lt;s STRING, t TIMESTAMP_LTZ(3)&gt;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Row</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">Instant</span><span class="o">.</span><span class="na">ofEpochSecond</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 允许任意类型的符入，并输出序列化定制后的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;RAW&#34;</span><span class="o">,</span> <span class="n">bridgedTo</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">ByteBuffer</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="o">=</span> <span class="n">InputGroup</span><span class="o">.</span><span class="na">ANY</span><span class="o">)</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MyUtils</span><span class="o">.</span><span class="na">serializeToByteBuffer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-f5e228c1-ded2-4892-a46d-fdb2431e6841"
    id="tabs-f5e228c1-ded2-4892-a46d-fdb2431e6841-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-f5e228c1-ded2-4892-a46d-fdb2431e6841-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">scala.annotation.varargs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// function with overloaded evaluation methods
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// no hint required
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 定义 decimal 的精度和小数位
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;DECIMAL(12, 3)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">double</span> <span class="n">a</span><span class="o">,</span> <span class="n">double</span> <span class="n">b</span><span class="o">)</span><span class="k">:</span> <span class="kt">BigDecimal</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="n">valueOf</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 定义嵌套数据类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;ROW&lt;s STRING, t TIMESTAMP_LTZ(3)&gt;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="nc">Int</span> <span class="n">i</span><span class="o">)</span><span class="k">:</span> <span class="kt">Row</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Row</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">String</span><span class="o">.</span><span class="n">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">java</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="nc">Instant</span><span class="o">.</span><span class="n">ofEpochSecond</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 允许任意类型的符入，并输出定制序列化后的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">value</span> <span class="k">=</span> <span class="s">&#34;RAW&#34;</span><span class="o">,</span> <span class="n">bridgedTo</span> <span class="k">=</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">java.nio.ByteBuffer</span><span class="o">])</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="k">=</span> <span class="nc">InputGroup</span><span class="o">.</span><span class="nc">ANY</span><span class="o">)</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span><span class="k">:</span> <span class="kt">java.nio.ByteBuffer</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nc">MyUtils</span><span class="o">.</span><span class="n">serializeToByteBuffer</span><span class="o">(</span><span class="n">o</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div></div>

<p><strong><code>@FunctionHint</code></strong></p>
<p>有时我们希望一种求值方法可以同时处理多种数据类型，有时又要求对重载的多个求值方法仅声明一次通用的结果类型。</p>
<p><code>@FunctionHint</code> 注解可以提供从入参数据类型到结果数据类型的映射，它可以在整个函数类或求值方法上注解输入、累加器和结果的数据类型。可以在类顶部声明一个或多个注解，也可以为类的所有求值方法分别声明一个或多个注解。所有的 hint 参数都是可选的，如果未定义参数，则使用默认的基于反射的类型提取。在函数类顶部定义的 hint 参数被所有求值方法继承。</p>
<p>以下例子展示了如何使用 <code>@FunctionHint</code>，详情可参考该注解类的文档。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-89e481b6-9709-4f8d-883b-921f0e67b041"
    id="tabs-89e481b6-9709-4f8d-883b-921f0e67b041-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-89e481b6-9709-4f8d-883b-921f0e67b041-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 为函数类的所有求值方法指定同一个输出类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;ROW&lt;s STRING, i INT&gt;&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="n">TableFunction</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect</span><span class="o">(</span><span class="n">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;Sum&#34;</span><span class="o">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// overloading of arguments is still possible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect</span><span class="o">(</span><span class="n">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;Empty args&#34;</span><span class="o">,</span> <span class="o">-</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 解耦类型推导与求值方法，类型推导完全取决于 FunctionHint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@FunctionHint</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">input</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;INT&#34;</span><span class="o">),</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;INT&#34;</span><span class="o">)},</span>
</span></span><span class="line"><span class="cl">  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;INT&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@FunctionHint</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">input</span> <span class="o">=</span> <span class="o">{</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;BIGINT&#34;</span><span class="o">),</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;BIGINT&#34;</span><span class="o">)},</span>
</span></span><span class="line"><span class="cl">  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;BIGINT&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@FunctionHint</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">input</span> <span class="o">=</span> <span class="o">{},</span>
</span></span><span class="line"><span class="cl">  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;BOOLEAN&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="n">TableFunction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// an implementer just needs to make sure that a method exists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// that can be called by the JVM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">collect</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect</span><span class="o">(</span><span class="n">o</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-89e481b6-9709-4f8d-883b-921f0e67b041"
    id="tabs-89e481b6-9709-4f8d-883b-921f0e67b041-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-89e481b6-9709-4f8d-883b-921f0e67b041-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 为函数类的所有求值方法指定同一个输出类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;ROW&lt;s STRING, i INT&gt;&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">Row</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="s">&#34;Sum&#34;</span><span class="o">,</span> <span class="nc">Int</span><span class="o">.</span><span class="n">box</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// overloading of arguments is still possible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">def</span> <span class="n">eval</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="s">&#34;Empty args&#34;</span><span class="o">,</span> <span class="nc">Int</span><span class="o">.</span><span class="n">box</span><span class="o">(-</span><span class="mi">1</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 解耦类型推导与求值方法，类型推导完全取决于 @FunctionHint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@FunctionHint</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;INT&#34;</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;INT&#34;</span><span class="o">)),</span>
</span></span><span class="line"><span class="cl">  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;INT&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@FunctionHint</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;BIGINT&#34;</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;BIGINT&#34;</span><span class="o">)),</span>
</span></span><span class="line"><span class="cl">  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;BIGINT&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@FunctionHint</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;BOOLEAN&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">AnyRef</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// an implementer just needs to make sure that a method exists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// that can be called by the JVM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@varargs</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef*</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">collect</span><span class="o">(</span><span class="nc">Boolean</span><span class="o">.</span><span class="n">box</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">collect</span><span class="o">(</span><span class="n">o</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div></div>

<h4 id="定制类型推导">
  定制类型推导
  <a class="anchor" href="#%e5%ae%9a%e5%88%b6%e7%b1%bb%e5%9e%8b%e6%8e%a8%e5%af%bc">#</a>
</h4>
<p>在大多数情况下，<code>@DataTypeHint</code> 和 <code>@FunctionHint</code> 足以构建自定义函数，然而通过重写 <code>getTypeInference()</code> 定制自动类型推导逻辑，实现者可以创建任意像系统内置函数那样有用的函数。</p>
<p>以下用 Java 实现的例子展示了定制类型推导的潜力，它根据字符串参数来确定函数的结果类型。该函数带有两个字符串参数：第一个参数表示要分析的字符串，第二个参数表示目标类型。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-db47e1b8-e387-432a-8bd5-1317e12ff64b"
    id="tabs-db47e1b8-e387-432a-8bd5-1317e12ff64b-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-db47e1b8-e387-432a-8bd5-1317e12ff64b-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.DataTypes</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.catalog.DataTypeFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.types.inference.TypeInference</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LiteralFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s">&#34;INT&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s">&#34;DOUBLE&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s">&#34;STRING&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 禁用自动的反射式类型推导，使用如下逻辑进行类型推导
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">TypeInference</span> <span class="nf">getTypeInference</span><span class="o">(</span><span class="n">DataTypeFactory</span> <span class="n">typeFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TypeInference</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 指定输入参数的类型，必要时参数会被隐式转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">.</span><span class="na">typedArguments</span><span class="o">(</span><span class="n">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">(),</span> <span class="n">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// specify a strategy for the result data type of the function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">.</span><span class="na">outputTypeStrategy</span><span class="o">(</span><span class="n">callContext</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">callContext</span><span class="o">.</span><span class="na">isArgumentLiteral</span><span class="o">(</span><span class="n">1</span><span class="o">)</span> <span class="o">||</span> <span class="n">callContext</span><span class="o">.</span><span class="na">isArgumentNull</span><span class="o">(</span><span class="n">1</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">throw</span> <span class="n">callContext</span><span class="o">.</span><span class="na">newValidationError</span><span class="o">(</span><span class="s">&#34;Literal expected for second argument.&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 基于字符串值返回数据类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="n">String</span> <span class="n">literal</span> <span class="o">=</span> <span class="n">callContext</span><span class="o">.</span><span class="na">getArgumentValue</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="s">&#34;STRING&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="o">(</span><span class="n">literal</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;INT&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">DataTypes</span><span class="o">.</span><span class="na">INT</span><span class="o">().</span><span class="na">notNull</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;DOUBLE&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">DataTypes</span><span class="o">.</span><span class="na">DOUBLE</span><span class="o">().</span><span class="na">notNull</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s">&#34;STRING&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">})</span>
</span></span><span class="line"><span class="cl">      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div></div>

<p>For more examples of custom type inference, see also the <code>flink-examples-table</code> module with

<a href="//github.com/apache/flink/blob/master/flink-examples/flink-examples-table/src/main/java/org/apache/flink/table/examples/java/functions/AdvancedFunctionsExample.java">
    advanced function implementation
</a>
.</p>
<h3 id="运行时集成">
  运行时集成
  <a class="anchor" href="#%e8%bf%90%e8%a1%8c%e6%97%b6%e9%9b%86%e6%88%90">#</a>
</h3>
<hr>
<p>有时候自定义函数需要获取一些全局信息，或者在真正被调用之前做一些配置（setup）/清理（clean-up）的工作。自定义函数也提供了 <code>open()</code> 和 <code>close()</code> 方法，你可以重写这两个方法做到类似于 DataStream API 中 <code>RichFunction</code> 的功能。</p>
<p>open() 方法在求值方法被调用之前先调用。close() 方法在求值方法调用完之后被调用。</p>
<p>open() 方法提供了一个 FunctionContext，它包含了一些自定义函数被执行时的上下文信息，比如 metric group、分布式文件缓存，或者是全局的作业参数等。</p>
<p>下面的信息可以通过调用 <code>FunctionContext</code> 的对应的方法来获得：</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>getMetricGroup()</code></td>
<td style="text-align:left">执行该函数的 subtask 的 Metric Group。</td>
</tr>
<tr>
<td style="text-align:left"><code>getCachedFile(name)</code></td>
<td style="text-align:left">分布式文件缓存的本地临时文件副本。</td>
</tr>
<tr>
<td style="text-align:left"><code>getJobParameter(name, defaultValue)</code></td>
<td style="text-align:left">跟对应的 key 关联的全局参数值。</td>
</tr>
</tbody>
</table>
<p>下面的例子展示了如何在一个标量函数中通过 FunctionContext 来获取一个全局的任务参数：</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-39170f36-8e99-464a-bc9c-0d052568ef8a"
    id="tabs-39170f36-8e99-464a-bc9c-0d052568ef8a-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-39170f36-8e99-464a-bc9c-0d052568ef8a-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.FunctionContext</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HashCodeFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="n">FunctionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取参数 &#34;hashcode_factor&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 如果不存在，则使用默认值 &#34;12&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">factor</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getJobParameter</span><span class="o">(</span><span class="s">&#34;hashcode_factor&#34;</span><span class="o">,</span> <span class="s">&#34;12&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">eval</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">*</span> <span class="n">factor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 设置任务参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">addJobParameter</span><span class="o">(</span><span class="s">&#34;hashcode_factor&#34;</span><span class="o">,</span> <span class="s">&#34;31&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;hashCode&#34;</span><span class="o">,</span> <span class="n">HashCodeFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT myField, hashCode(myField) FROM MyTable&#34;</span><span class="o">);</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-39170f36-8e99-464a-bc9c-0d052568ef8a"
    id="tabs-39170f36-8e99-464a-bc9c-0d052568ef8a-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-39170f36-8e99-464a-bc9c-0d052568ef8a-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.FunctionContext</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HashCodeFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">private</span> <span class="k">var</span> <span class="n">factor</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">override</span> <span class="k">def</span> <span class="n">open</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">FunctionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取参数 &#34;hashcode_factor&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果不存在，则使用默认值 &#34;12&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">factor</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getJobParameter</span><span class="o">(</span><span class="s">&#34;hashcode_factor&#34;</span><span class="o">,</span> <span class="s">&#34;12&#34;</span><span class="o">).</span><span class="n">toInt</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">hashCode</span> <span class="o">*</span> <span class="n">factor</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="n">create</span><span class="o">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 设置任务参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">getConfig</span><span class="o">.</span><span class="n">addJobParameter</span><span class="o">(</span><span class="s">&#34;hashcode_factor&#34;</span><span class="o">,</span> <span class="s">&#34;31&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;hashCode&#34;</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">HashCodeFunction</span><span class="o">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT myField, hashCode(myField) FROM MyTable&#34;</span><span class="o">)</span>
</span></span></code></pre></div></div></div>


<p><a href="#top" class="top pull-right"><i class="fas fa-triangle"></i> Back to top</a></p>


<h2 id="标量函数">
  标量函数
  <a class="anchor" href="#%e6%a0%87%e9%87%8f%e5%87%bd%e6%95%b0">#</a>
</h2>
<p>自定义标量函数可以把 0 到多个标量值映射成 1 个标量值，<a href="//localhost/flink/flink-docs-master/zh/docs/dev/table/types/">数据类型</a>里列出的任何数据类型都可作为求值方法的参数和返回值类型。</p>
<p>想要实现自定义标量函数，你需要扩展 <code>org.apache.flink.table.functions</code> 里面的 <code>ScalarFunction</code> 并且实现一个或者多个求值方法。标量函数的行为取决于你写的求值方法。求值方法必须是 <code>public</code> 的，而且名字必须是 <code>eval</code>。</p>
<p>下面的例子展示了如何实现一个求哈希值的函数并在查询里调用它，详情可参考<a href="#%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97">开发指南</a>：</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-6828e58c-65f1-4bed-a35e-63fec7aa8c19"
    id="tabs-6828e58c-65f1-4bed-a35e-63fec7aa8c19-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-6828e58c-65f1-4bed-a35e-63fec7aa8c19-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">org.apache.flink.table.api.Expressions.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HashFunction</span> <span class="kd">extends</span> <span class="n">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 接受任意类型输入，返回 INT 型输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="o">=</span> <span class="n">InputGroup</span><span class="o">.</span><span class="na">ANY</span><span class="o">)</span> <span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">HashFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;HashFunction&#34;</span><span class="o">,</span> <span class="n">HashFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;HashFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT HashFunction(myField) FROM MyTable&#34;</span><span class="o">);</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-6828e58c-65f1-4bed-a35e-63fec7aa8c19"
    id="tabs-6828e58c-65f1-4bed-a35e-63fec7aa8c19-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-6828e58c-65f1-4bed-a35e-63fec7aa8c19-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HashFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 接受任意类型输入，返回 INT 型输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="k">=</span> <span class="nc">InputGroup</span><span class="o">.</span><span class="nc">ANY</span><span class="o">)</span> <span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">return</span> <span class="kt">o.hashCode</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="n">create</span><span class="o">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">HashFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;HashFunction&#34;</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">HashFunction</span><span class="o">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">).</span><span class="n">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;HashFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT HashFunction(myField) FROM MyTable&#34;</span><span class="o">)</span>
</span></span></code></pre></div></div></div>

<p>如果你打算使用 Python 实现或调用标量函数，详情可参考 <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/udfs/python_udfs/#scalar-functions">Python 标量函数</a>。</p>

<p><a href="#top" class="top pull-right"><i class="fas fa-triangle"></i> Back to top</a></p>


<h2 id="表值函数">
  表值函数
  <a class="anchor" href="#%e8%a1%a8%e5%80%bc%e5%87%bd%e6%95%b0">#</a>
</h2>
<p>跟自定义标量函数一样，自定义表值函数的输入参数也可以是 0 到多个标量。但是跟标量函数只能返回一个值不同的是，它可以返回任意多行。返回的每一行可以包含 1 到多列，如果输出行只包含 1 列，会省略结构化信息并生成标量值，这个标量值在运行阶段会隐式地包装进行里。</p>
<p>要定义一个表值函数，你需要扩展 <code>org.apache.flink.table.functions</code> 下的 <code>TableFunction</code>，可以通过实现多个名为 <code>eval</code> 的方法对求值方法进行重载。像其他函数一样，输入和输出类型也可以通过反射自动提取出来。表值函数返回的表的类型取决于 <code>TableFunction</code> 类的泛型参数 <code>T</code>，不同于标量函数，表值函数的求值方法本身不包含返回类型，而是通过 <code>collect(T)</code> 方法来发送要输出的行。</p>
<p>在 Table API 中，表值函数是通过 <code>.joinLateral(...)</code> 或者 <code>.leftOuterJoinLateral(...)</code> 来使用的。<code>joinLateral</code> 算子会把外表（算子左侧的表）的每一行跟跟表值函数返回的所有行（位于算子右侧）进行 （cross）join。<code>leftOuterJoinLateral</code> 算子也是把外表（算子左侧的表）的每一行跟表值函数返回的所有行（位于算子右侧）进行（cross）join，并且如果表值函数返回 0 行也会保留外表的这一行。</p>
<p>在 SQL 里面用 <code>JOIN</code> 或者 以 <code>ON TRUE</code> 为条件的 <code>LEFT JOIN</code> 来配合 <code>LATERAL TABLE(&lt;TableFunction&gt;)</code> 的使用。</p>
<p>下面的例子展示了如何实现一个分隔函数并在查询里调用它，详情可参考<a href="#%e5%bc%80%e5%8f%91%e6%8c%87%e5%8d%97">开发指南</a>：</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-1cf0d01a-2559-4b16-bb98-9b348f37bdc0"
    id="tabs-1cf0d01a-2559-4b16-bb98-9b348f37bdc0-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-1cf0d01a-2559-4b16-bb98-9b348f37bdc0-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import static</span> <span class="nn">org.apache.flink.table.api.Expressions.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">&#34;ROW&lt;word STRING, length INT&gt;&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SplitFunction</span> <span class="kd">extends</span> <span class="n">TableFunction</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">str</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&#34; &#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// use collect(...) to emit a row
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">collect</span><span class="o">(</span><span class="n">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="n">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;word&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;length&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;word&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;length&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里重命名函数字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">&#34;newWord&#34;</span><span class="o">,</span> <span class="s">&#34;newLength&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;newWord&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;newLength&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;SplitFunction&#34;</span><span class="o">,</span> <span class="n">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;SplitFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;word&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;length&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;SplitFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">)))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">$</span><span class="o">(</span><span class="s">&#34;myField&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;word&#34;</span><span class="o">),</span> <span class="n">$</span><span class="o">(</span><span class="s">&#34;length&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;SELECT myField, word, length &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;FROM MyTable, LATERAL TABLE(SplitFunction(myField))&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;SELECT myField, word, length &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;FROM MyTable &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;LEFT JOIN LATERAL TABLE(SplitFunction(myField)) ON TRUE&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里重命名函数字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;SELECT myField, newWord, newLength &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;FROM MyTable &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;LEFT JOIN LATERAL TABLE(SplitFunction(myField)) AS T(newWord, newLength) ON TRUE&#34;</span><span class="o">);</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-1cf0d01a-2559-4b16-bb98-9b348f37bdc0"
    id="tabs-1cf0d01a-2559-4b16-bb98-9b348f37bdc0-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-1cf0d01a-2559-4b16-bb98-9b348f37bdc0-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">&#34;ROW&lt;word STRING, length INT&gt;&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SplitFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">Row</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">eval</span><span class="o">(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// use collect(...) to emit a row
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&#34; &#34;</span><span class="o">).</span><span class="n">foreach</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nc">Int</span><span class="o">.</span><span class="n">box</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">length</span><span class="o">))))</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="n">env</span> <span class="k">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="n">create</span><span class="o">(...)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里不经注册直接“内联”调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;word&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;length&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;word&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;length&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里重命名函数字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">).</span><span class="n">as</span><span class="o">(</span><span class="s">&#34;newWord&#34;</span><span class="o">,</span> <span class="s">&#34;newLength&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;newWord&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;newLength&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">createTemporarySystemFunction</span><span class="o">(</span><span class="s">&#34;SplitFunction&#34;</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 Table API 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;SplitFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;word&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;length&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">from</span><span class="o">(</span><span class="s">&#34;MyTable&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">&#34;SplitFunction&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;myField&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;word&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;length&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里调用注册好的函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">sqlQuery</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;SELECT myField, word, length &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;FROM MyTable, LATERAL TABLE(SplitFunction(myField))&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">env</span><span class="o">.</span><span class="n">sqlQuery</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;SELECT myField, word, length &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;FROM MyTable &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;LEFT JOIN LATERAL TABLE(SplitFunction(myField)) ON TRUE&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在 SQL 里重命名函数字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">env</span><span class="o">.</span><span class="n">sqlQuery</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;SELECT myField, newWord, newLength &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;FROM MyTable &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;LEFT JOIN LATERAL TABLE(SplitFunction(myField)) AS T(newWord, newLength) ON TRUE&#34;</span><span class="o">)</span>
</span></span></code></pre></div></div></div>

<p>如果你打算使用 Scala，不要把表值函数声明为 Scala <code>object</code>，Scala <code>object</code> 是单例对象，将导致并发问题。</p>
<p>如果你打算使用 Python 实现或调用表值函数，详情可参考 <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/udfs/python_udfs/#table-functions">Python 表值函数</a>。</p>

<p><a href="#top" class="top pull-right"><i class="fas fa-triangle"></i> Back to top</a></p>


<h2 id="聚合函数">
  聚合函数
  <a class="anchor" href="#%e8%81%9a%e5%90%88%e5%87%bd%e6%95%b0">#</a>
</h2>
<p>自定义聚合函数（UDAGG）是把一个表（一行或者多行，每行可以有一列或者多列）聚合成一个标量值。</p>

<img 
  src="//localhost/flink/flink-docs-master/fig/udagg-mechanism.png"
  alt="UDAGG mechanism"
  width="80%"
  style="display:block;margin-left:auto;margin-right:auto"
>
<p>上面的图片展示了一个聚合的例子。假设你有一个关于饮料的表。表里面有三个字段，分别是 <code>id</code>、<code>name</code>、<code>price</code>，表里有 5 行数据。假设你需要找到所有饮料里最贵的饮料的价格，即执行一个 <code>max()</code> 聚合。你需要遍历所有 5 行数据，而结果就只有一个数值。</p>
<p>自定义聚合函数是通过扩展 <code>AggregateFunction</code> 来实现的。<code>AggregateFunction</code> 的工作过程如下。首先，它需要一个 <code>accumulator</code>，它是一个数据结构，存储了聚合的中间结果。通过调用 <code>AggregateFunction</code> 的 <code>createAccumulator()</code> 方法创建一个空的 accumulator。接下来，对于每一行数据，会调用 <code>accumulate()</code> 方法来更新 accumulator。当所有的数据都处理完了之后，通过调用 <code>getValue</code> 方法来计算和返回最终的结果。</p>
<p><strong>下面几个方法是每个 <code>AggregateFunction</code> 必须要实现的：</strong></p>
<ul>
<li><code>createAccumulator()</code></li>
<li><code>accumulate()</code></li>
<li><code>getValue()</code></li>
</ul>
<p>Flink 的类型推导在遇到复杂类型的时候可能会推导出错误的结果，比如那些非基本类型和普通的 POJO 类型的复杂类型。所以跟 <code>ScalarFunction</code> 和 <code>TableFunction</code> 一样，<code>AggregateFunction</code> 也提供了 <code>AggregateFunction#getResultType()</code> 和 <code>AggregateFunction#getAccumulatorType()</code> 来分别指定返回值类型和 accumulator 的类型，两个函数的返回值类型也都是 <code>TypeInformation</code>。</p>
<p>除了上面的方法，还有几个方法可以选择实现。这些方法有些可以让查询更加高效，而有些是在某些特定场景下必须要实现的。例如，如果聚合函数用在会话窗口（当两个会话窗口合并的时候需要 merge 他们的 accumulator）的话，<code>merge()</code> 方法就是必须要实现的。</p>
<p><strong><code>AggregateFunction</code> 的以下方法在某些场景下是必须实现的：</strong></p>
<ul>
<li><code>retract()</code> 在 bounded <code>OVER</code> 窗口中是必须实现的。</li>
<li><code>merge()</code> 在许多批式聚合和会话以及滚动窗口聚合中是必须实现的。除此之外，这个方法对于优化也很多帮助。例如，两阶段聚合优化就需要所有的 <code>AggregateFunction</code> 都实现 <code>merge</code> 方法。</li>
<li><code>resetAccumulator()</code> 在许多批式聚合中是必须实现的。</li>
</ul>
<p><code>AggregateFunction</code> 的所有方法都必须是 <code>public</code> 的，不能是 <code>static</code> 的，而且名字必须跟上面写的一样。<code>createAccumulator</code>、<code>getValue</code>、<code>getResultType</code> 以及 <code>getAccumulatorType</code> 这几个函数是在抽象类 <code>AggregateFunction</code> 中定义的，而其他函数都是约定的方法。如果要定义一个聚合函数，你需要扩展 <code>org.apache.flink.table.functions.AggregateFunction</code>，并且实现一个（或者多个）<code>accumulate</code> 方法。<code>accumulate</code> 方法可以重载，每个方法的参数类型不同，并且支持变长参数。</p>
<p><code>AggregateFunction</code> 的所有方法的详细文档如下。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-55ea8f05-96d8-462f-8bc4-8316da3d097b"
    id="tabs-55ea8f05-96d8-462f-8bc4-8316da3d097b-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-55ea8f05-96d8-462f-8bc4-8316da3d097b-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for user-defined aggregates and table aggregates.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;T&gt;   the type of the aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute an aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">UserDefinedFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Creates and init the Accumulator for this (table)aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return the accumulator with the initial value
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">ACC</span> <span class="nf">createAccumulator</span><span class="o">();</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s result.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s result or null if the result
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">TypeInformation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">getResultType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s accumulator or null if the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         accumulator type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">TypeInformation</span><span class="o">&lt;</span><span class="n">ACC</span><span class="o">&gt;</span> <span class="n">getAccumulatorType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for aggregation functions.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;T&gt;   the type of the aggregation result
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute an aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             AggregateFunction represents its state using accumulator, thereby the state of the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             AggregateFunction must be put into the accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AggregateFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ACC</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/** Processes the input values and update the provided accumulator instance. The method
</span></span></span><span class="line"><span class="cl"><span class="cm">    * accumulate can be overloaded with different custom types and arguments. An AggregateFunction
</span></span></span><span class="line"><span class="cl"><span class="cm">    * requires at least one accumulate() method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Retracts the input values from the accumulator instance. The current design assumes the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * inputs are the values that have been previously accumulated. The method retract can be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * overloaded with different custom types and arguments. This function must be implemented for
</span></span></span><span class="line"><span class="cl"><span class="cm">    * datastream bounded over aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Merges a group of accumulator instances into one accumulator instance. This function must be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * implemented for datastream session window grouping aggregate and bounded grouping aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     be noted that the accumulator may contain the previous aggregated
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     results. Therefore user should not replace or clean this instance in the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     custom merge method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param its          an {@link java.lang.Iterable} pointed to a group of accumulators that will be
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     merged.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="n">ACC</span><span class="o">&gt;</span> <span class="n">its</span><span class="o">);</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called every time when an aggregation result should be materialized.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * The returned value could be either an early and incomplete result
</span></span></span><span class="line"><span class="cl"><span class="cm">    * (periodically emitted as data arrive) or the final result of the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * aggregation.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator the accumulator which contains the current
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return the aggregation result
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">T</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">);</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Resets the accumulator for this [[AggregateFunction]]. This function must be implemented for
</span></span></span><span class="line"><span class="cl"><span class="cm">    * bounded grouping aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator  the accumulator which needs to be reset
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">);</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns true if this AggregateFunction can only be applied in an OVER window.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return true if the AggregateFunction requires an OVER window, false otherwise.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Boolean</span> <span class="n">requiresOver</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-55ea8f05-96d8-462f-8bc4-8316da3d097b"
    id="tabs-55ea8f05-96d8-462f-8bc4-8316da3d097b-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-55ea8f05-96d8-462f-8bc4-8316da3d097b-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for user-defined aggregates and table aggregates.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam T   the type of the aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute an aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Creates and init the Accumulator for this (table)aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return the accumulator with the initial value
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">ACC</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s result.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s result or null if the result
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">getResultType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s accumulator or null if the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         accumulator type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">getAccumulatorType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">ACC</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for aggregation functions.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam T   the type of the aggregation result
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute an aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             AggregateFunction represents its state using accumulator, thereby the state of the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             AggregateFunction must be put into the accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">AggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Processes the input values and update the provided accumulator instance. The method
</span></span></span><span class="line"><span class="cl"><span class="cm">    * accumulate can be overloaded with different custom types and arguments. An AggregateFunction
</span></span></span><span class="line"><span class="cl"><span class="cm">    * requires at least one accumulate() method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">accumulate</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Retracts the input values from the accumulator instance. The current design assumes the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * inputs are the values that have been previously accumulated. The method retract can be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * overloaded with different custom types and arguments. This function must be implemented for
</span></span></span><span class="line"><span class="cl"><span class="cm">    * datastream bounded over aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">retract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Merges a group of accumulator instances into one accumulator instance. This function must be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * implemented for datastream session window grouping aggregate and bounded grouping aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     be noted that the accumulator may contain the previous aggregated
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     results. Therefore user should not replace or clean this instance in the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     custom merge method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param its          an [[java.lang.Iterable]] pointed to a group of accumulators that will be
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     merged.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">merge</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">its</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">ACC</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called every time when an aggregation result should be materialized.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * The returned value could be either an early and incomplete result
</span></span></span><span class="line"><span class="cl"><span class="cm">    * (periodically emitted as data arrive) or the final result of the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * aggregation.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator the accumulator which contains the current
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return the aggregation result
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">getValue</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Resets the accumulator for this [[AggregateFunction]]. This function must be implemented for
</span></span></span><span class="line"><span class="cl"><span class="cm">    * bounded grouping aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator  the accumulator which needs to be reset
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">resetAccumulator</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns true if this AggregateFunction can only be applied in an OVER window.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return true if the AggregateFunction requires an OVER window, false otherwise.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">requiresOver</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div></div></div>

<p>下面的例子展示了如何：</p>
<ul>
<li>定义一个聚合函数来计算某一列的加权平均，</li>
<li>在 <code>TableEnvironment</code> 中注册函数，</li>
<li>在查询中使用函数。</li>
</ul>
<p>为了计算加权平均值，accumulator 需要存储加权总和以及数据的条数。在我们的例子里，我们定义了一个类 <code>WeightedAvgAccum</code> 来作为 accumulator。Flink 的 checkpoint 机制会自动保存 accumulator，在失败时进行恢复，以此来保证精确一次的语义。</p>
<p>我们的 <code>WeightedAvg</code>（聚合函数）的 <code>accumulate</code> 方法有三个输入参数。第一个是 <code>WeightedAvgAccum</code> accumulator，另外两个是用户自定义的输入：输入的值 <code>ivalue</code> 和 输入的权重 <code>iweight</code>。尽管 <code>retract()</code>、<code>merge()</code>、<code>resetAccumulator()</code> 这几个方法在大多数聚合类型中都不是必须实现的，我们也在样例中提供了他们的实现。请注意我们在 Scala 样例中也是用的是 Java 的基础类型，并且定义了 <code>getResultType()</code> 和 <code>getAccumulatorType()</code>，因为 Flink 的类型推导对于 Scala 的类型推导做的不是很好。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c"
    id="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Accumulator for WeightedAvg.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeightedAvgAccum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Weighted Average user-defined aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeightedAvg</span> <span class="kd">extends</span> <span class="n">AggregateFunction</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">WeightedAvgAccum</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">WeightedAvgAccum</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">WeightedAvgAccum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">/</span> <span class="n">acc</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">,</span> <span class="kt">long</span> <span class="n">iValue</span><span class="o">,</span> <span class="kt">int</span> <span class="n">iWeight</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">+=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">+=</span> <span class="n">iWeight</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="n">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">,</span> <span class="kt">long</span> <span class="n">iValue</span><span class="o">,</span> <span class="kt">int</span> <span class="n">iWeight</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">-=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">-=</span> <span class="n">iWeight</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="n">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">,</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">WeightedAvgAccum</span><span class="o">&gt;</span> <span class="n">it</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">WeightedAvgAccum</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">WeightedAvgAccum</span> <span class="n">a</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">sum</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="n">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">StreamTableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">tEnv</span><span class="o">.</span><span class="na">registerFunction</span><span class="o">(</span><span class="s">&#34;wAvg&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">WeightedAvg</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">tEnv</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT user, wAvg(points, level) AS avgPoints FROM userScores GROUP BY user&#34;</span><span class="o">);</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c"
    id="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">java.lang.</span><span class="o">{</span><span class="nc">Long</span> <span class="k">=&gt;</span> <span class="nc">JLong</span><span class="o">,</span> <span class="nc">Integer</span> <span class="k">=&gt;</span> <span class="nc">JInteger</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.api.java.tuple.</span><span class="o">{</span><span class="nc">Tuple1</span> <span class="k">=&gt;</span> <span class="nc">JTuple1</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.api.java.typeutils.TupleTypeInfo</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api.Types</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.AggregateFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Accumulator for WeightedAvg.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">WeightedAvgAccum</span> <span class="k">extends</span> <span class="nc">JTuple1</span><span class="o">[</span><span class="kt">JLong</span>, <span class="kt">JInteger</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">sum</span> <span class="k">=</span> <span class="mi">0L</span>
</span></span><span class="line"><span class="cl">  <span class="n">count</span> <span class="k">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Weighted Average user-defined aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">WeightedAvg</span> <span class="k">extends</span> <span class="nc">AggregateFunction</span><span class="o">[</span><span class="kt">JLong</span>, <span class="kt">CountAccumulator</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">override</span> <span class="k">def</span> <span class="n">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="nc">WeightedAvgAccum</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">override</span> <span class="k">def</span> <span class="n">getValue</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">)</span><span class="k">:</span> <span class="kt">JLong</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="n">sum</span> <span class="o">/</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">,</span> <span class="n">iValue</span><span class="k">:</span> <span class="kt">JLong</span><span class="o">,</span> <span class="n">iWeight</span><span class="k">:</span> <span class="kt">JInteger</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">iWeight</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">retract</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">,</span> <span class="n">iValue</span><span class="k">:</span> <span class="kt">JLong</span><span class="o">,</span> <span class="n">iWeight</span><span class="k">:</span> <span class="kt">JInteger</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">sum</span> <span class="o">-=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">count</span> <span class="o">-=</span> <span class="n">iWeight</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">merge</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">,</span> <span class="n">it</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">WeightedAvgAccum</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">iter</span> <span class="k">=</span> <span class="n">it</span><span class="o">.</span><span class="n">iterator</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="n">hasNext</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">iter</span><span class="o">.</span><span class="n">next</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="n">count</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="n">sum</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">resetAccumulator</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">count</span> <span class="k">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">sum</span> <span class="k">=</span> <span class="mi">0L</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">override</span> <span class="k">def</span> <span class="n">getAccumulatorType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">WeightedAvgAccum</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="nc">TupleTypeInfo</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">WeightedAvgAccum</span><span class="o">],</span> <span class="nc">Types</span><span class="o">.</span><span class="nc">LONG</span><span class="o">,</span> <span class="nc">Types</span><span class="o">.</span><span class="nc">INT</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">override</span> <span class="k">def</span> <span class="n">getResultType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">JLong</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Types</span><span class="o">.</span><span class="nc">LONG</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">tEnv</span><span class="k">:</span> <span class="kt">StreamTableEnvironment</span> <span class="o">=</span> <span class="o">???</span>
</span></span><span class="line"><span class="cl"><span class="n">tEnv</span><span class="o">.</span><span class="n">registerFunction</span><span class="o">(</span><span class="s">&#34;wAvg&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WeightedAvg</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">tEnv</span><span class="o">.</span><span class="n">sqlQuery</span><span class="o">(</span><span class="s">&#34;SELECT user, wAvg(points, level) AS avgPoints FROM userScores GROUP BY user&#34;</span><span class="o">)</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Python"
    name="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c"
    id="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c-2"
     
    onclick="onSwitch('Python')"
  />
  <label for="tabs-ee5bdf7f-9cb8-4b3a-9522-8d20cd97522c-2">Python</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Java code:
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/**
</span></span></span><span class="line"><span class="cl"><span class="s1"> * Accumulator for WeightedAvg.
</span></span></span><span class="line"><span class="cl"><span class="s1"> */
</span></span></span><span class="line"><span class="cl"><span class="s1">public static class WeightedAvgAccum {
</span></span></span><span class="line"><span class="cl"><span class="s1">    public long sum = 0;
</span></span></span><span class="line"><span class="cl"><span class="s1">    public int count = 0;
</span></span></span><span class="line"><span class="cl"><span class="s1">}
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">// The java class must have a public no-argument constructor and can be founded in current java classloader.
</span></span></span><span class="line"><span class="cl"><span class="s1">// Java 类必须有一个 public 的无参构造函数，并且可以在当前类加载器中加载到。
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">/**
</span></span></span><span class="line"><span class="cl"><span class="s1"> * Weighted Average user-defined aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="s1"> */
</span></span></span><span class="line"><span class="cl"><span class="s1">public static class WeightedAvg extends AggregateFunction&lt;Long, WeightedAvgAccum&gt; {
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    @Override
</span></span></span><span class="line"><span class="cl"><span class="s1">    public WeightedAvgAccum createAccumulator() {
</span></span></span><span class="line"><span class="cl"><span class="s1">        return new WeightedAvgAccum();
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    @Override
</span></span></span><span class="line"><span class="cl"><span class="s1">    public Long getValue(WeightedAvgAccum acc) {
</span></span></span><span class="line"><span class="cl"><span class="s1">        if (acc.count == 0) {
</span></span></span><span class="line"><span class="cl"><span class="s1">            return null;
</span></span></span><span class="line"><span class="cl"><span class="s1">        } else {
</span></span></span><span class="line"><span class="cl"><span class="s1">            return acc.sum / acc.count;
</span></span></span><span class="line"><span class="cl"><span class="s1">        }
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    public void accumulate(WeightedAvgAccum acc, long iValue, int iWeight) {
</span></span></span><span class="line"><span class="cl"><span class="s1">        acc.sum += iValue * iWeight;
</span></span></span><span class="line"><span class="cl"><span class="s1">        acc.count += iWeight;
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    public void retract(WeightedAvgAccum acc, long iValue, int iWeight) {
</span></span></span><span class="line"><span class="cl"><span class="s1">        acc.sum -= iValue * iWeight;
</span></span></span><span class="line"><span class="cl"><span class="s1">        acc.count -= iWeight;
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    public void merge(WeightedAvgAccum acc, Iterable&lt;WeightedAvgAccum&gt; it) {
</span></span></span><span class="line"><span class="cl"><span class="s1">        Iterator&lt;WeightedAvgAccum&gt; iter = it.iterator();
</span></span></span><span class="line"><span class="cl"><span class="s1">        while (iter.hasNext()) {
</span></span></span><span class="line"><span class="cl"><span class="s1">            WeightedAvgAccum a = iter.next();
</span></span></span><span class="line"><span class="cl"><span class="s1">            acc.count += a.count;
</span></span></span><span class="line"><span class="cl"><span class="s1">            acc.sum += a.sum;
</span></span></span><span class="line"><span class="cl"><span class="s1">        }
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    public void resetAccumulator(WeightedAvgAccum acc) {
</span></span></span><span class="line"><span class="cl"><span class="s1">        acc.count = 0;
</span></span></span><span class="line"><span class="cl"><span class="s1">        acc.sum = 0L;
</span></span></span><span class="line"><span class="cl"><span class="s1">    }
</span></span></span><span class="line"><span class="cl"><span class="s1">}
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 注册函数</span>
</span></span><span class="line"><span class="cl"><span class="n">t_env</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># type: StreamTableEnvironment</span>
</span></span><span class="line"><span class="cl"><span class="n">t_env</span><span class="o">.</span><span class="n">register_java_function</span><span class="p">(</span><span class="s2">&#34;wAvg&#34;</span><span class="p">,</span> <span class="s2">&#34;my.java.function.WeightedAvg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用函数</span>
</span></span><span class="line"><span class="cl"><span class="n">t_env</span><span class="o">.</span><span class="n">sql_query</span><span class="p">(</span><span class="s2">&#34;SELECT user, wAvg(points, level) AS avgPoints FROM userScores GROUP BY user&#34;</span><span class="p">)</span>
</span></span></code></pre></div></div></div>

<p>如果你打算使用 Python 实现或调用聚合函数，详情可参考 <a href="//localhost/flink/flink-docs-master/zh/docs/dev/python/table/udfs/python_udfs/#aggregate-functions">Python 聚合函数</a>。</p>

<p><a href="#top" class="top pull-right"><i class="fas fa-triangle"></i> Back to top</a></p>


<h2 id="表值聚合函数">
  表值聚合函数
  <a class="anchor" href="#%e8%a1%a8%e5%80%bc%e8%81%9a%e5%90%88%e5%87%bd%e6%95%b0">#</a>
</h2>
<p>自定义表值聚合函数（UDTAGG）可以把一个表（一行或者多行，每行有一列或者多列）聚合成另一张表，结果中可以有多行多列。</p>

<img 
  src="//localhost/flink/flink-docs-master/fig/udtagg-mechanism.png"
  alt="UDAGG mechanism"
  width="80%"
  style="display:block;margin-left:auto;margin-right:auto"
>
<p>上图展示了一个表值聚合函数的例子。假设你有一个饮料的表，这个表有 3 列，分别是 <code>id</code>、<code>name</code> 和 <code>price</code>，一共有 5 行。假设你需要找到价格最高的两个饮料，类似于 <code>top2()</code> 表值聚合函数。你需要遍历所有 5 行数据，结果是有 2 行数据的一个表。</p>
<p>用户自定义表值聚合函数是通过扩展 <code>TableAggregateFunction</code> 类来实现的。一个 <code>TableAggregateFunction</code> 的工作过程如下。首先，它需要一个 <code>accumulator</code>，这个 <code>accumulator</code> 负责存储聚合的中间结果。 通过调用 <code>TableAggregateFunction</code> 的 <code>createAccumulator</code> 方法来构造一个空的 accumulator。接下来，对于每一行数据，会调用 <code>accumulate</code> 方法来更新 accumulator。当所有数据都处理完之后，调用 <code>emitValue</code> 方法来计算和返回最终的结果。</p>
<p><strong>下面几个 <code>TableAggregateFunction</code> 的方法是必须要实现的：</strong></p>
<ul>
<li><code>createAccumulator()</code></li>
<li><code>accumulate()</code></li>
</ul>
<p>Flink 的类型推导在遇到复杂类型的时候可能会推导出错误的结果，比如那些非基本类型和普通的 POJO 类型的复杂类型。所以类似于 <code>ScalarFunction</code> 和 <code>TableFunction</code>，<code>TableAggregateFunction</code> 也提供了 <code>TableAggregateFunction#getResultType()</code> 和 <code>TableAggregateFunction#getAccumulatorType()</code> 方法来指定返回值类型和 accumulator 的类型，这两个方法都需要返回 <code>TypeInformation</code>。</p>
<p>除了上面的方法，还有几个其他的方法可以选择性的实现。有些方法可以让查询更加高效，而有些方法对于某些特定场景是必须要实现的。比如，在会话窗口（当两个会话窗口合并时会合并两个 accumulator）中使用聚合函数时，必须要实现<code>merge()</code> 方法。</p>
<p><strong>下面几个 <code>TableAggregateFunction</code> 的方法在某些特定场景下是必须要实现的：</strong></p>
<ul>
<li><code>retract()</code> 在 bounded <code>OVER</code> 窗口中的聚合函数必须要实现。</li>
<li><code>merge()</code> 在许多批式聚合和以及流式会话和滑动窗口聚合中是必须要实现的。</li>
<li><code>resetAccumulator()</code> 在许多批式聚合中是必须要实现的。</li>
<li><code>emitValue()</code> 在批式聚合以及窗口聚合中是必须要实现的。</li>
</ul>
<p><strong>下面的 <code>TableAggregateFunction</code> 的方法可以提升流式任务的效率：</strong></p>
<ul>
<li><code>emitUpdateWithRetract()</code> 在 retract 模式下，该方法负责发送被更新的值。</li>
</ul>
<p><code>emitValue</code> 方法会发送所有 accumulator 给出的结果。拿 TopN 来说，<code>emitValue</code> 每次都会发送所有的最大的 n 个值。这在流式任务中可能会有一些性能问题。为了提升性能，用户可以实现 <code>emitUpdateWithRetract</code> 方法。这个方法在 retract 模式下会增量的输出结果，比如有数据更新了，我们必须要撤回老的数据，然后再发送新的数据。如果定义了 <code>emitUpdateWithRetract</code> 方法，那它会优先于 <code>emitValue</code> 方法被使用，因为一般认为 <code>emitUpdateWithRetract</code> 会更加高效，因为它的输出是增量的。</p>
<p><code>TableAggregateFunction</code> 的所有方法都必须是 <code>public</code> 的、非 <code>static</code> 的，而且名字必须跟上面提到的一样。<code>createAccumulator</code>、<code>getResultType</code> 和 <code>getAccumulatorType</code> 这三个方法是在抽象父类 <code>TableAggregateFunction</code> 中定义的，而其他的方法都是约定的方法。要实现一个表值聚合函数，你必须扩展 <code>org.apache.flink.table.functions.TableAggregateFunction</code>，并且实现一个（或者多个）<code>accumulate</code> 方法。<code>accumulate</code> 方法可以有多个重载的方法，也可以支持变长参数。</p>
<p><code>TableAggregateFunction</code> 的所有方法的详细文档如下。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-be05e2c1-92b0-4373-8ef8-cf7dce67f85c"
    id="tabs-be05e2c1-92b0-4373-8ef8-cf7dce67f85c-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-be05e2c1-92b0-4373-8ef8-cf7dce67f85c-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for user-defined aggregates and table aggregates.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;T&gt;   the type of the aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute an aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">UserDefinedFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Creates and init the Accumulator for this (table)aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return the accumulator with the initial value
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">ACC</span> <span class="nf">createAccumulator</span><span class="o">();</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s result.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s result or null if the result
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">TypeInformation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">getResultType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s accumulator or null if the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         accumulator type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">TypeInformation</span><span class="o">&lt;</span><span class="n">ACC</span><span class="o">&gt;</span> <span class="n">getAccumulatorType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for table aggregation functions.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;T&gt;   the type of the aggregation result
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute a table aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             TableAggregateFunction represents its state using accumulator, thereby the state of
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             the TableAggregateFunction must be put into the accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TableAggregateFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">ACC</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/** Processes the input values and update the provided accumulator instance. The method
</span></span></span><span class="line"><span class="cl"><span class="cm">    * accumulate can be overloaded with different custom types and arguments. A TableAggregateFunction
</span></span></span><span class="line"><span class="cl"><span class="cm">    * requires at least one accumulate() method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Retracts the input values from the accumulator instance. The current design assumes the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * inputs are the values that have been previously accumulated. The method retract can be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * overloaded with different custom types and arguments. This function must be implemented for
</span></span></span><span class="line"><span class="cl"><span class="cm">    * datastream bounded over aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Merges a group of accumulator instances into one accumulator instance. This function must be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * implemented for datastream session window grouping aggregate and bounded grouping aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     be noted that the accumulator may contain the previous aggregated
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     results. Therefore user should not replace or clean this instance in the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     custom merge method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param its          an {@link java.lang.Iterable} pointed to a group of accumulators that will be
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     merged.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="n">ACC</span><span class="o">&gt;</span> <span class="n">its</span><span class="o">);</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called every time when an aggregation result should be materialized. The returned value
</span></span></span><span class="line"><span class="cl"><span class="cm">    * could be either an early and incomplete result  (periodically emitted as data arrive) or
</span></span></span><span class="line"><span class="cl"><span class="cm">    * the final result of the  aggregation.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator the accumulator which contains the current
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param out         the collector used to output data
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitValue</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">);</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called every time when an aggregation result should be materialized. The returned value
</span></span></span><span class="line"><span class="cl"><span class="cm">    * could be either an early and incomplete result (periodically emitted as data arrive) or
</span></span></span><span class="line"><span class="cl"><span class="cm">    * the final result of the aggregation.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Different from emitValue, emitUpdateWithRetract is used to emit values that have been updated.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * This method outputs data incrementally in retract mode, i.e., once there is an update, we
</span></span></span><span class="line"><span class="cl"><span class="cm">    * have to retract old records before sending new updated ones. The emitUpdateWithRetract
</span></span></span><span class="line"><span class="cl"><span class="cm">    * method will be used in preference to the emitValue method if both methods are defined in the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * table aggregate function, because the method is treated to be more efficient than emitValue
</span></span></span><span class="line"><span class="cl"><span class="cm">    * as it can outputvalues incrementally.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator the accumulator which contains the current
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param out         the retractable collector used to output data. Use collect method
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    to output(add) records and use retract method to retract(delete)
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    records.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span><span class="n">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">RetractableCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">);</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Collects a record and forwards it. The collector can output retract messages with the retract
</span></span></span><span class="line"><span class="cl"><span class="cm">    * method. Note: only use it in {@code emitRetractValueIncrementally}.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RetractableCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Retract a record.
</span></span></span><span class="line"><span class="cl"><span class="cm">        *
</span></span></span><span class="line"><span class="cl"><span class="cm">        * @param record The record to retract.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">      <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="n">T</span> <span class="n">record</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-be05e2c1-92b0-4373-8ef8-cf7dce67f85c"
    id="tabs-be05e2c1-92b0-4373-8ef8-cf7dce67f85c-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-be05e2c1-92b0-4373-8ef8-cf7dce67f85c-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for user-defined aggregates and table aggregates.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam T   the type of the aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute an aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedFunction</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Creates and init the Accumulator for this (table)aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return the accumulator with the initial value
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">ACC</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s result.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s result or null if the result
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">getResultType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Returns the TypeInformation of the (table)aggregate function&#39;s accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @return The TypeInformation of the (table)aggregate function&#39;s accumulator or null if the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *         accumulator type should be automatically inferred.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">getAccumulatorType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">ACC</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">  * Base class for table aggregation functions.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam T   the type of the aggregation result
</span></span></span><span class="line"><span class="cl"><span class="cm">  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             aggregated values which are needed to compute an aggregation result.
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             TableAggregateFunction represents its state using accumulator, thereby the state of
</span></span></span><span class="line"><span class="cl"><span class="cm">  *             the TableAggregateFunction must be put into the accumulator.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Processes the input values and update the provided accumulator instance. The method
</span></span></span><span class="line"><span class="cl"><span class="cm">    * accumulate can be overloaded with different custom types and arguments. A TableAggregateFunction
</span></span></span><span class="line"><span class="cl"><span class="cm">    * requires at least one accumulate() method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">accumulate</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// MANDATORY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Retracts the input values from the accumulator instance. The current design assumes the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * inputs are the values that have been previously accumulated. The method retract can be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * overloaded with different custom types and arguments. This function must be implemented for
</span></span></span><span class="line"><span class="cl"><span class="cm">    * datastream bounded over aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator           the accumulator which contains the current aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">retract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Merges a group of accumulator instances into one accumulator instance. This function must be
</span></span></span><span class="line"><span class="cl"><span class="cm">    * implemented for datastream session window grouping aggregate and bounded grouping aggregate.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     be noted that the accumulator may contain the previous aggregated
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     results. Therefore user should not replace or clean this instance in the
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     custom merge method.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param its          an [[java.lang.Iterable]] pointed to a group of accumulators that will be
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                     merged.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">merge</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">its</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">ACC</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called every time when an aggregation result should be materialized. The returned value
</span></span></span><span class="line"><span class="cl"><span class="cm">    * could be either an early and incomplete result  (periodically emitted as data arrive) or
</span></span></span><span class="line"><span class="cl"><span class="cm">    * the final result of the  aggregation.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator the accumulator which contains the current
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param out         the collector used to output data
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">emitValue</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Called every time when an aggregation result should be materialized. The returned value
</span></span></span><span class="line"><span class="cl"><span class="cm">    * could be either an early and incomplete result (periodically emitted as data arrive) or
</span></span></span><span class="line"><span class="cl"><span class="cm">    * the final result of the aggregation.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Different from emitValue, emitUpdateWithRetract is used to emit values that have been updated.
</span></span></span><span class="line"><span class="cl"><span class="cm">    * This method outputs data incrementally in retract mode, i.e., once there is an update, we
</span></span></span><span class="line"><span class="cl"><span class="cm">    * have to retract old records before sending new updated ones. The emitUpdateWithRetract
</span></span></span><span class="line"><span class="cl"><span class="cm">    * method will be used in preference to the emitValue method if both methods are defined in the
</span></span></span><span class="line"><span class="cl"><span class="cm">    * table aggregate function, because the method is treated to be more efficient than emitValue
</span></span></span><span class="line"><span class="cl"><span class="cm">    * as it can outputvalues incrementally.
</span></span></span><span class="line"><span class="cl"><span class="cm">    *
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param accumulator the accumulator which contains the current
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    aggregated results
</span></span></span><span class="line"><span class="cl"><span class="cm">    * @param out         the retractable collector used to output data. Use collect method
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    to output(add) records and use retract method to retract(delete)
</span></span></span><span class="line"><span class="cl"><span class="cm">    *                    records.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">emitUpdateWithRetract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">RetractableCollector</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Collects a record and forwards it. The collector can output retract messages with the retract
</span></span></span><span class="line"><span class="cl"><span class="cm">    * method. Note: only use it in `emitRetractValueIncrementally`.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">  <span class="k">trait</span> <span class="nc">RetractableCollector</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Collector</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">      * Retract a record.
</span></span></span><span class="line"><span class="cl"><span class="cm">      *
</span></span></span><span class="line"><span class="cl"><span class="cm">      * @param record The record to retract.
</span></span></span><span class="line"><span class="cl"><span class="cm">      */</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="n">retract</span><span class="o">(</span><span class="n">record</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div></div></div>

<p>下面的例子展示了如何</p>
<ul>
<li>定义一个 <code>TableAggregateFunction</code> 来计算给定列的最大的 2 个值，</li>
<li>在 <code>TableEnvironment</code> 中注册函数，</li>
<li>在 Table API 查询中使用函数（当前只在 Table API 中支持 TableAggregateFunction）。</li>
</ul>
<p>为了计算最大的 2 个值，accumulator 需要保存当前看到的最大的 2 个值。在我们的例子中，我们定义了类 <code>Top2Accum</code> 来作为 accumulator。Flink 的 checkpoint 机制会自动保存 accumulator，并且在失败时进行恢复，来保证精确一次的语义。</p>
<p>我们的 <code>Top2</code> 表值聚合函数（<code>TableAggregateFunction</code>）的 <code>accumulate()</code> 方法有两个输入，第一个是 <code>Top2Accum</code> accumulator，另一个是用户定义的输入：输入的值 <code>v</code>。尽管 <code>merge()</code> 方法在大多数聚合类型中不是必须的，我们也在样例中提供了它的实现。请注意，我们在 Scala 样例中也使用的是 Java 的基础类型，并且定义了 <code>getResultType()</code> 和 <code>getAccumulatorType()</code> 方法，因为 Flink 的类型推导对于 Scala 的类型推导支持的不是很好。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-1348443b-e70d-4e88-888a-69a21ecc7857"
    id="tabs-1348443b-e70d-4e88-888a-69a21ecc7857-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-1348443b-e70d-4e88-888a-69a21ecc7857-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Accumulator for Top2.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">first</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">second</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The top2 user-defined table aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2</span> <span class="kd">extends</span> <span class="n">TableAggregateFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Top2Accum</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Top2Accum</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Top2Accum</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Top2Accum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="n">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="n">Top2Accum</span><span class="o">&gt;</span> <span class="n">iterable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Top2Accum</span> <span class="n">otherAcc</span> <span class="o">:</span> <span class="n">iterable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">otherAcc</span><span class="o">.</span><span class="na">first</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">otherAcc</span><span class="o">.</span><span class="na">second</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitValue</span><span class="o">(</span><span class="n">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// emit the value and rank
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">!=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">,</span> <span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">!=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">,</span> <span class="n">2</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">StreamTableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">tEnv</span><span class="o">.</span><span class="na">registerFunction</span><span class="o">(</span><span class="s">&#34;top2&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Top2</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 初始化表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Table</span> <span class="n">tab</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">tab</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">&#34;key&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">flatAggregate</span><span class="o">(</span><span class="s">&#34;top2(a) as (v, rank)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">&#34;key, v, rank&#34;</span><span class="o">);</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-1348443b-e70d-4e88-888a-69a21ecc7857"
    id="tabs-1348443b-e70d-4e88-888a-69a21ecc7857-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-1348443b-e70d-4e88-888a-69a21ecc7857-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">java.lang.</span><span class="o">{</span><span class="nc">Integer</span> <span class="k">=&gt;</span> <span class="nc">JInteger</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api.Types</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Accumulator for top2.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="n">first</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="n">second</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The top2 user-defined table aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Top2</span> <span class="k">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]</span>, <span class="kt">Top2Accum</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">override</span> <span class="k">def</span> <span class="n">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Top2Accum</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">acc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Top2Accum</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">first</span> <span class="k">=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="k">=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">v</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="n">first</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="k">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">first</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">first</span> <span class="k">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="n">second</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="k">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">merge</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">its</span><span class="k">:</span> <span class="kt">JIterable</span><span class="o">[</span><span class="kt">Top2Accum</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">iter</span> <span class="k">=</span> <span class="n">its</span><span class="o">.</span><span class="n">iterator</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="n">hasNext</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">val</span> <span class="n">top2</span> <span class="k">=</span> <span class="n">iter</span><span class="o">.</span><span class="n">next</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">top2</span><span class="o">.</span><span class="n">first</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">top2</span><span class="o">.</span><span class="n">second</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">emitValue</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// emit the value and rank
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">first</span> <span class="o">!=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="nc">JTuple2</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="o">!=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="nc">JTuple2</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 初始化表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">tab</span> <span class="k">=</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">tab</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span>&#39;key<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">flatAggregate</span><span class="o">(</span><span class="n">top2</span><span class="o">(</span>&#39;a<span class="o">)</span> <span class="n">as</span> <span class="o">(</span>&#39;v<span class="o">,</span> &#39;rank<span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">select</span><span class="o">(</span>&#39;key<span class="o">,</span> &#39;v<span class="o">,</span> &#39;rank<span class="o">)</span>
</span></span></code></pre></div></div></div>

<p>下面的例子展示了如何使用 <code>emitUpdateWithRetract</code> 方法来只发送更新的数据。为了只发送更新的结果，accumulator 保存了上一次的最大的2个值，也保存了当前最大的2个值。注意：如果 TopN 中的 n 非常大，这种既保存上次的结果，也保存当前的结果的方式不太高效。一种解决这种问题的方式是把输入数据直接存储到 <code>accumulator</code> 中，然后在调用 <code>emitUpdateWithRetract</code> 方法时再进行计算。</p>





<div class="book-tabs"><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Java"
    name="tabs-e0d841fe-8d95-4706-9e19-e76141171966"
    id="tabs-e0d841fe-8d95-4706-9e19-e76141171966-0"
    checked="checked" 
    onclick="onSwitch('Java')"
  />
  <label for="tabs-e0d841fe-8d95-4706-9e19-e76141171966-0">Java</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Accumulator for Top2.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">first</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">second</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">oldFirst</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Integer</span> <span class="n">oldSecond</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The top2 user-defined table aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2</span> <span class="kd">extends</span> <span class="n">TableAggregateFunction</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;,</span> <span class="n">Top2Accum</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Top2Accum</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Top2Accum</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Top2Accum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span><span class="n">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="n">RetractableCollector</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// if there is an update, retract old value then emit new value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">!=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="o">.</span><span class="na">retract</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span><span class="o">,</span> <span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">,</span> <span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// if there is an update, retract old value then emit new value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">!=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span><span class="o">.</span><span class="na">retract</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span><span class="o">,</span> <span class="n">2</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">,</span> <span class="n">2</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">StreamTableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">tEnv</span><span class="o">.</span><span class="na">registerFunction</span><span class="o">(</span><span class="s">&#34;top2&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Top2</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 初始化表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Table</span> <span class="n">tab</span> <span class="o">=</span> <span class="o">...;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">tab</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">&#34;key&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">flatAggregate</span><span class="o">(</span><span class="s">&#34;top2(a) as (v, rank)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">&#34;key, v, rank&#34;</span><span class="o">);</span>
</span></span></code></pre></div></div><input 
    type="radio"
    class="toggle"
    data-tab-group="flink-tabs"
    data-tab-item="Scala"
    name="tabs-e0d841fe-8d95-4706-9e19-e76141171966"
    id="tabs-e0d841fe-8d95-4706-9e19-e76141171966-1"
     
    onclick="onSwitch('Scala')"
  />
  <label for="tabs-e0d841fe-8d95-4706-9e19-e76141171966-1">Scala</label>
  <div class="book-tabs-content markdown-inner"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-scala" data-lang="scala"><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">java.lang.</span><span class="o">{</span><span class="nc">Integer</span> <span class="k">=&gt;</span> <span class="nc">JInteger</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.api.Types</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Accumulator for top2.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="n">first</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="n">second</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="n">oldFirst</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl">  <span class="k">var</span> <span class="n">oldSecond</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The top2 user-defined table aggregate function.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Top2</span> <span class="k">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]</span>, <span class="kt">Top2Accum</span><span class="o">]</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">override</span> <span class="k">def</span> <span class="n">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Top2Accum</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="n">acc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Top2Accum</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">first</span> <span class="k">=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="k">=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">oldFirst</span> <span class="k">=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="o">.</span><span class="n">oldSecond</span> <span class="k">=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">v</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="n">first</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="k">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">first</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">first</span> <span class="k">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="n">second</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="k">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="n">emitUpdateWithRetract</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span><span class="k">:</span> <span class="kt">RetractableCollector</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]])</span>
</span></span><span class="line"><span class="cl">  <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">first</span> <span class="o">!=</span> <span class="n">acc</span><span class="o">.</span><span class="n">oldFirst</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// if there is an update, retract old value then emit new value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">oldFirst</span> <span class="o">!=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="n">retract</span><span class="o">(</span><span class="nc">JTuple2</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">oldFirst</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="nc">JTuple2</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">oldFirst</span> <span class="k">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">first</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">second</span> <span class="o">!=</span> <span class="n">acc</span><span class="o">.</span><span class="n">oldSecond</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// if there is an update, retract old value then emit new value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">oldSecond</span> <span class="o">!=</span> <span class="nc">Int</span><span class="o">.</span><span class="nc">MinValue</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="o">.</span><span class="n">retract</span><span class="o">(</span><span class="nc">JTuple2</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">oldSecond</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">out</span><span class="o">.</span><span class="n">collect</span><span class="o">(</span><span class="nc">JTuple2</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="n">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">      <span class="n">acc</span><span class="o">.</span><span class="n">oldSecond</span> <span class="k">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">second</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 初始化表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">val</span> <span class="n">tab</span> <span class="k">=</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">tab</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span>&#39;key<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">flatAggregate</span><span class="o">(</span><span class="n">top2</span><span class="o">(</span>&#39;a<span class="o">)</span> <span class="n">as</span> <span class="o">(</span>&#39;v<span class="o">,</span> &#39;rank<span class="o">))</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="n">select</span><span class="o">(</span>&#39;key<span class="o">,</span> &#39;v<span class="o">,</span> &#39;rank<span class="o">)</span>
</span></span></code></pre></div></div></div>


<p><a href="#top" class="top pull-right"><i class="fas fa-triangle"></i> Back to top</a></p>


</article>
 
      

      <footer class="book-footer">
        
  




	


<a href="https://cwiki.apache.org/confluence/display/FLINK/Flink+Translation+Specifications">Want to contribute translation?</a>
<br><br>
<a href="//github.com/apache/flink/edit/master/docs/content.zh/docs/dev/table/functions/udfs.md" style="color:black"><i class="fa fa-edit fa-fw"></i>Edit This Page</a>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  

<nav id="TableOfContents"><h3>On This Page <button class="toc" onclick="collapseToc()"><i class="fa fa-compress" aria-hidden="true"></i></button></h3>
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#开发指南">开发指南</a>
      <ul>
        <li><a href="#函数类">函数类</a></li>
        <li><a href="#求值方法">求值方法</a></li>
        <li><a href="#类型推导">类型推导</a></li>
        <li><a href="#运行时集成">运行时集成</a></li>
      </ul>
    </li>
    <li><a href="#标量函数">标量函数</a></li>
    <li><a href="#表值函数">表值函数</a></li>
    <li><a href="#聚合函数">聚合函数</a></li>
    <li><a href="#表值聚合函数">表值聚合函数</a></li>
  </ul>
</nav>

 
    </aside>
    <aside class="expand-toc">
      <button class="toc" onclick="expandToc()">
        <i class="fa fa-expand" aria-hidden="true"></i>
      </button>
    </aside>
    
  </main>

  

</body>

</html>












